<!doctype html><html lang=en><meta charset=utf-8><title>YBlog - Use git to calculate trusted mtimes</title><meta name=keywords content="nanoc,web,git"><link rel="shortcut icon" type=image/x-icon href=../../../../Scratch/img/favicon.ico><link rel=stylesheet href=../../../../Scratch/css/brutalist.css><link rel=stylesheet href=../../../../Scratch/css/pandoc-solarized.css><link rel=alternate type=application/rss+xml title=RSS href=../../../../Scratch/en/blog/feed/feed.xml><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon href=../../../../Scratch/img/about/FlatAvatar@2x.png><link href=https://twitter.com/yogsototh rel=me><link href=https://github.com/yogsototh rel=me><link href=mailto:yann.esposito@gmail.com rel=me><link rel=pgpkey href=../../../../pubkey.txt><body lang=en class=an><div id=content><div id=header><div id=choix><span id=choixlang><a href=../../../../Scratch/fr/blog/2010-09-02-Use-git-to-calculate-trusted-mtimes/>French</a></span>
<span class=ap><a href=#navigation>↓ Menu ↓</a></span>
<span class=bo></span></div></div><div id=titre><h1>Use git to calculate trusted mtimes</h1></div><div class=bo></div><div id=afterheader class=an><div class=bq><p>You can remark at the bottom of each page I provide a last modification date. This label was first calculated using the <code>mtime</code> of the file on the file system. But many times I modify this date just to force some recompilation. Therefore the date wasn’t a date of <em>real</em> modification.<p>I use <a href=http://git-scm.org>git</a> to version my website. And fortunately I can know the last date of <em>real</em> change of a file. This is how I do this with <a href=http://nanoc.stoneship.org>nanoc</a>:<div class=n id=cb1><pre class="n ruby"><code class="n ruby"><a class=m id=cb1-1 title=1><span class=kw>def</span> gitmtime</a>
<a class=m id=cb1-2 title=2>    filepath=<span class=ot>@item</span>.path.sub(<span class=st>'/Scratch/'</span>,<span class=st>'content/html/'</span>).sub(<span class=ot>/\/$/</span>,<span class=st>''</span>)</a>
<a class=m id=cb1-3 title=3>    ext=<span class=ot>%{</span><span class=st>.</span><span class=ot>#{@item</span>[<span class=st>:extension</span>]<span class=ot>}}</span></a>
<a class=m id=cb1-4 title=4>    filepath&lt;&lt;=ext</a>
<a class=m id=cb1-5 title=5>    <span class=kw>if</span> <span class=kw>not</span> <span class=dt>FileTest</span>.exists?(filepath)</a>
<a class=m id=cb1-6 title=6>        filepath.sub!(ext,<span class=ot>%{#{@item</span>.raw_filename<span class=ot>}#{</span>ext<span class=ot>}}</span>)</a>
<a class=m id=cb1-7 title=7>    <span class=kw>end</span></a>
<a class=m id=cb1-8 title=8>    str=<span class=st>`git log -1 --format='%ci' -- </span><span class=ot>#{</span>filepath<span class=ot>}</span><span class=st>`</span></a>
<a class=m id=cb1-9 title=9>    <span class=kw>if</span> str.nil? <span class=kw>or</span> str.empty?</a>
<a class=m id=cb1-10 title=10>        <span class=kw>return</span> <span class=dt>Time</span>.now</a>
<a class=m id=cb1-11 title=11>    <span class=kw>else</span></a>
<a class=m id=cb1-12 title=12>        <span class=kw>return</span> <span class=dt>DateTime</span>.parse( str )</a>
<a class=m id=cb1-13 title=13>    <span class=kw>end</span></a>
<a class=m id=cb1-14 title=14><span class=kw>end</span></a></code></pre></div><p>Of course I know it is really slow and absolutely not optimized. But it works as expected. Now the date you see at the bottom is exactly the date I modified the <em>content</em> of the page.<p><em>Edit</em>: Thanks to Eric Sunshine and Kris to provide me some hints at cleaning my code.</div><div id=afterarticle><div id=social><a href=../../../../Scratch/en/blog/feed/feed.xml target=_blank rel="noopener noreferrer nofollow" class=as>RSS</a>
·
<a href="https://twitter.com/home?status=http%3A%2F%2Fyannesposito.com/Scratch/en/blog/2010-09-02-Use-git-to-calculate-trusted-mtimes/%20via%20@yogsototh" target=_blank rel="noopener noreferrer nofollow" class=as>Tweet</a>
·
<a href="http://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fyannesposito.com/Scratch/en/blog/2010-09-02-Use-git-to-calculate-trusted-mtimes/" target=_blank rel="noopener noreferrer nofollow" class=as>FB</a><br><a class=ag href=../../../../Scratch/en/blog/Social-link-the-right-way/>These social sharing links preserve your privacy</a></div><div id=navigation><a href=../../../../>Home</a>
<span class=cr>¦</span>
<a href=../../../../Scratch/en/blog>Blog</a>
<span class=cr>¦</span>
<a href=../../../../Scratch/en/softwares>Softwares</a>
<span class=cr>¦</span>
<a href=../../../../Scratch/en/about>About</a></div><div id=totop><a href=#header>↑ Top ↑</a></div><div id=bottom><div>Published on 2010-09-02</div><div><a href=https://twitter.com/yogsototh>Follow @yogsototh</a></div><div><a rel=license href=http://creativecommons.org/licenses/by/3.0/deed.en_US>Yann Esposito©</a></div><div>Done with
<a href=http://www.vim.org target=_blank rel="noopener noreferrer nofollow"><strike>Vim</strike></a>
<a href=http://spacemacs.org target=_blank rel="noopener noreferrer nofollow">spacemacs</a>
<span class=ca>&</span>
<a href=http://nanoc.ws target=_blank rel="noopener noreferrer nofollow"><strike>nanoc</strike></a>
<a href=http://jaspervdj.be/hakyll target=_blank rel="noopener noreferrer nofollow">Hakyll</a></div><hr><div style=max-width:100%><a href=https://cardanohub.org><img src=../../../../Scratch/img/ada-logo.png class=au style=height:16px;border-radius:50%;vertical-align:middle;display:inline-block>
ADA:</a>
<code style=display:inline-block;word-wrap:break-word;text-align:left;vertical-align:top;max-width:85%>DdzFFzCqrhtAvdkmATx5Fm8NPJViDy85ZBw13p4XcNzVzvQg8e3vWLXq23JQWFxPEXK6Kvhaxxe7oJt4VMYHxpA2vtCFiP8fziohN6Yp</code></div></div></div></div></div>