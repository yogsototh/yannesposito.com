<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Optimize the size of no js websites</title><meta name=author content="Yann Esposito"><meta name=description content><meta name=keywords content><link rel=stylesheet href=/css/y.css><link rel=alternate type=application/rss+xml href=/rss.xml><link rel=icon href=/favicon.ico><input name=t type=radio id=b>
<input name=t type=radio id=l>
<input name=t type=radio id=d>
<input name=t type=radio id=g><div id=labels><div class=ak><label for=b>book</label>&nbsp;
/&nbsp;
<label for=l>light</label>&nbsp;
<span id=logo><a href=/><svg width="5em" viewBox="0 0 64 64"><circle cx="32" cy="32" r="30" stroke="var(--b2)" stroke-width="2" fill="var(--b03)"/><circle cx="32" cy="32" r="12" stroke="var(--r)" stroke-width="2" fill="var(--o)"/><circle cx="32" cy="32" r="6" stroke-width="0" fill="var(--y)"/><ellipse cx="32" cy="14" rx="14" ry="8" stroke-width="0" fill="var(--b3)"/></svg></a></span>&nbsp;
<label for=d>dark</label>&nbsp;
/&nbsp;
<label for=g>geek</label></div></div><div class=cc><div id=preamble class=aq><div class=ak><h1>Optimize the size of no js websites</h1><div class=ca><span class=am-date>2019-12-06</span> on
<a href=https://her.esy.fun><span class=bc>Yann Esposito</span>'s blog</a> -
<a href=/posts/0009-optim-nojs-website/index.org>source</a> -
<a href=/posts/0009-optim-nojs-website/index.gmi>gmi</a> -
<a href=/posts/0009-optim-nojs-website/index.pdf>pdf</a> -
<a class=q href=https://her.esy.fun/posts/0009-optim-nojs-website/index.html>§permalink</a></div><div class=ac></div></div></div><div id=content><p>One of the major problem with CSS and HTML is that they are highly dependent from each other. For example, if you want to minimize your CSS, you are still forced to use the same class names even if they are long. Because the HTML uses them. And the same problem arise when you want to minimize the size of your HTML files.<p>It means that if you want to minimize a full website you must take care at the same time of HTML pages as well as CSS pages. And this is totally impossible to achieve if JS is involved because there is always the risk the JS code generate class names to manipulate the DOM.<p>So here is a small script I wanted to write from a long time that do the following:<ol><li>retrieve all class names in the HTML and in the CSS<li>create a map from those long names to shorter names<li>replace the class names in the HTML and CSS files.</ol><p>So if you have multiple HTML files with:<div class=n id=cb1><pre class="n html"><code class="n html"><span id=cb1-1><a href=#cb1-1 aria-hidden=true tabindex=-1></a><span class=kw>&lt;div</span><span class=ot> class=</span><span class=st>&quot;long-org-class-generated-by-org-mode&quot;</span><span class=kw>&gt;</span>...<span class=kw>&lt;/div&gt;</span></span></code></pre></div><p>and CSS files with:<div class=n id=cb2><pre class="n css"><code class="n css"><span id=cb2-1><a href=#cb2-1 aria-hidden=true tabindex=-1></a>pre <span class=fu>.long-org-class-generated-by-org-mode</span> { <span class=fu>...</span> }</span></code></pre></div><p>Those will be replaced by something like:<div class=n id=cb3><pre class="n html"><code class="n html"><span id=cb3-1><a href=#cb3-1 aria-hidden=true tabindex=-1></a><span class=kw>&lt;div</span><span class=ot> class=</span><span class=st>&quot;av&quot;</span><span class=kw>&gt;</span>...<span class=kw>&lt;/div&gt;</span></span></code></pre></div><p>and CSS files with:<div class=n id=cb4><pre class="n css"><code class="n css"><span id=cb4-1><a href=#cb4-1 aria-hidden=true tabindex=-1></a>pre <span class=fu>.av</span> { <span class=fu>...</span> }</span></code></pre></div><p>And thus removing many superfluous bytes.<p>In my personal website, I run this script after minifying my HTML and CSS with classical tools. And I still get up to 32% smaller HTML and 22% smaller CSS.<p>Many 25% smaller HTML if there are a lot of code, because org-mode use very long class names when generating the code.<p>Not bad for a very basic solution.<p>If you want to try it; here is the quick and dirty script I use:<div class=n id=optim-classes.sh><pre class="n bash"><code class="n bash"><span id=optim-classes.sh-1><a href=#optim-classes.sh-1 aria-hidden=true tabindex=-1></a><span class=co>#!/usr/bin/env zsh</span></span>
<span id=optim-classes.sh-2><a href=#optim-classes.sh-2 aria-hidden=true tabindex=-1></a></span>
<span id=optim-classes.sh-3><a href=#optim-classes.sh-3 aria-hidden=true tabindex=-1></a><span class=va>webdir</span><span class=op>=</span><span class=st>&quot;_site&quot;</span></span>
<span id=optim-classes.sh-4><a href=#optim-classes.sh-4 aria-hidden=true tabindex=-1></a></span>
<span id=optim-classes.sh-5><a href=#optim-classes.sh-5 aria-hidden=true tabindex=-1></a><span class=fu>retrieve_classes_in_html ()</span> <span class=kw>{</span></span>
<span id=optim-classes.sh-6><a href=#optim-classes.sh-6 aria-hidden=true tabindex=-1></a>    <span class=fu>cat</span> <span class=va>$webdir</span>/<span class=pp>**</span>/<span class=pp>*</span>.html<span class=er>(</span><span class=ex>N</span><span class=kw>)</span> <span class=kw>|</span> <span class=dt>\</span></span>
<span id=optim-classes.sh-7><a href=#optim-classes.sh-7 aria-hidden=true tabindex=-1></a>        <span class=fu>perl</span> <span class=at>-pe</span> <span class=st>&#39;s/class=&quot;?([a-zA-Z0-9_-]*)/\nCLASS: $1\n/g&#39;</span></span>
<span id=optim-classes.sh-8><a href=#optim-classes.sh-8 aria-hidden=true tabindex=-1></a><span class=kw>}</span></span>
<span id=optim-classes.sh-9><a href=#optim-classes.sh-9 aria-hidden=true tabindex=-1></a></span>
<span id=optim-classes.sh-10><a href=#optim-classes.sh-10 aria-hidden=true tabindex=-1></a><span class=fu>retrieve_classes_in_css ()</span> <span class=kw>{</span></span>
<span id=optim-classes.sh-11><a href=#optim-classes.sh-11 aria-hidden=true tabindex=-1></a>    <span class=fu>cat</span> <span class=va>$webdir</span>/<span class=pp>**</span>/<span class=pp>*</span>.css<span class=er>(</span><span class=ex>N</span><span class=kw>)</span> <span class=kw>|</span> <span class=dt>\</span></span>
<span id=optim-classes.sh-12><a href=#optim-classes.sh-12 aria-hidden=true tabindex=-1></a>        <span class=fu>perl</span> <span class=at>-pe</span> <span class=st>&#39;s/\.([a-zA-Z-_][a-zA-Z0-9-_]*)/\nCLASS: $1\n/g&#39;</span></span>
<span id=optim-classes.sh-13><a href=#optim-classes.sh-13 aria-hidden=true tabindex=-1></a><span class=kw>}</span></span>
<span id=optim-classes.sh-14><a href=#optim-classes.sh-14 aria-hidden=true tabindex=-1></a></span>
<span id=optim-classes.sh-15><a href=#optim-classes.sh-15 aria-hidden=true tabindex=-1></a><span class=va>classes</span><span class=op>=</span><span class=va>(</span> <span class=va>$(</span> <span class=ex>{retrieve_classes_in_html</span><span class=kw>;</span> <span class=ex>retrieve_classes_in_css}</span><span class=kw>|</span> <span class=dt>\</span></span>
<span id=optim-classes.sh-16><a href=#optim-classes.sh-16 aria-hidden=true tabindex=-1></a>                 <span class=fu>egrep</span> <span class=st>&quot;^CLASS: [^ ]*$&quot;</span> <span class=kw>|</span><span class=dt>\</span></span>
<span id=optim-classes.sh-17><a href=#optim-classes.sh-17 aria-hidden=true tabindex=-1></a>                 <span class=fu>sort</span> <span class=at>-u</span> <span class=kw>|</span> <span class=dt>\</span></span>
<span id=optim-classes.sh-18><a href=#optim-classes.sh-18 aria-hidden=true tabindex=-1></a>                 <span class=fu>awk</span> <span class=st>&#39;length($2)&gt;2 {print length($2),$2}&#39;</span><span class=kw>|</span><span class=dt>\</span></span>
<span id=optim-classes.sh-19><a href=#optim-classes.sh-19 aria-hidden=true tabindex=-1></a>                 <span class=fu>sort</span> <span class=at>-rn</span> <span class=kw>|</span> <span class=dt>\</span></span>
<span id=optim-classes.sh-20><a href=#optim-classes.sh-20 aria-hidden=true tabindex=-1></a>                 <span class=fu>awk</span> <span class=st>&#39;{print $2}&#39;</span><span class=va>)</span> <span class=va>)</span></span>
<span id=optim-classes.sh-21><a href=#optim-classes.sh-21 aria-hidden=true tabindex=-1></a></span>
<span id=optim-classes.sh-22><a href=#optim-classes.sh-22 aria-hidden=true tabindex=-1></a><span class=fu>chr()</span> <span class=kw>{</span></span>
<span id=optim-classes.sh-23><a href=#optim-classes.sh-23 aria-hidden=true tabindex=-1></a>    <span class=bu>[</span> <span class=st>&quot;</span><span class=va>$1</span><span class=st>&quot;</span> <span class=ot>-lt</span> 26 <span class=bu>]</span> <span class=kw>||</span> <span class=cf>return</span> <span class=dv>1</span></span>
<span id=optim-classes.sh-24><a href=#optim-classes.sh-24 aria-hidden=true tabindex=-1></a>    <span class=bu>printf</span> <span class=st>&quot;</span><span class=dt>\\</span><span class=va>$(</span><span class=bu>printf</span> <span class=st>&#39;%03o&#39;</span> <span class=va>$((</span> <span class=dv>97</span> <span class=op>+</span> <span class=va>$1</span> <span class=va>)))</span><span class=st>&quot;</span></span>
<span id=optim-classes.sh-25><a href=#optim-classes.sh-25 aria-hidden=true tabindex=-1></a><span class=kw>}</span></span>
<span id=optim-classes.sh-26><a href=#optim-classes.sh-26 aria-hidden=true tabindex=-1></a></span>
<span id=optim-classes.sh-27><a href=#optim-classes.sh-27 aria-hidden=true tabindex=-1></a><span class=fu>shortName()</span> <span class=kw>{</span></span>
<span id=optim-classes.sh-28><a href=#optim-classes.sh-28 aria-hidden=true tabindex=-1></a>    <span class=cf>if</span> <span class=bu>[</span> <span class=st>&quot;</span><span class=va>$1</span><span class=st>&quot;</span> <span class=ot>-gt</span> 25 <span class=bu>]</span><span class=kw>;</span> <span class=cf>then</span></span>
<span id=optim-classes.sh-29><a href=#optim-classes.sh-29 aria-hidden=true tabindex=-1></a>        <span class=ex>print</span> <span class=at>--</span> <span class=va>$(</span><span class=ex>shortName</span> <span class=va>$((</span> ( <span class=va>$1</span> <span class=op>/</span> <span class=dv>26</span> ) <span class=op>-</span> <span class=dv>1</span> <span class=va>)))$(</span><span class=ex>shortName</span> <span class=va>$((</span> <span class=va>$1</span> <span class=op>%</span> <span class=dv>26</span> <span class=va>)))</span></span>
<span id=optim-classes.sh-30><a href=#optim-classes.sh-30 aria-hidden=true tabindex=-1></a>    <span class=cf>else</span></span>
<span id=optim-classes.sh-31><a href=#optim-classes.sh-31 aria-hidden=true tabindex=-1></a>        <span class=ex>chr</span> <span class=va>$1</span></span>
<span id=optim-classes.sh-32><a href=#optim-classes.sh-32 aria-hidden=true tabindex=-1></a>    <span class=cf>fi</span></span>
<span id=optim-classes.sh-33><a href=#optim-classes.sh-33 aria-hidden=true tabindex=-1></a><span class=kw>}</span></span>
<span id=optim-classes.sh-34><a href=#optim-classes.sh-34 aria-hidden=true tabindex=-1></a></span>
<span id=optim-classes.sh-35><a href=#optim-classes.sh-35 aria-hidden=true tabindex=-1></a><span class=va>i</span><span class=op>=</span>0<span class=kw>;</span></span>
<span id=optim-classes.sh-36><a href=#optim-classes.sh-36 aria-hidden=true tabindex=-1></a><span class=bu>typeset</span> <span class=at>-A</span> <span class=va>assoc</span></span>
<span id=optim-classes.sh-37><a href=#optim-classes.sh-37 aria-hidden=true tabindex=-1></a><span class=cf>for</span> c <span class=kw>in</span> <span class=va>$classes</span><span class=kw>;</span> <span class=cf>do</span></span>
<span id=optim-classes.sh-38><a href=#optim-classes.sh-38 aria-hidden=true tabindex=-1></a>    <span class=va>sn</span><span class=op>=</span><span class=va>$(</span><span class=ex>shortName</span> <span class=va>$i)</span></span>
<span id=optim-classes.sh-39><a href=#optim-classes.sh-39 aria-hidden=true tabindex=-1></a>    <span class=ex>print</span> <span class=at>--</span> <span class=st>&quot;</span><span class=va>$c</span><span class=st> -&gt; </span><span class=va>$sn</span><span class=st>&quot;</span></span>
<span id=optim-classes.sh-40><a href=#optim-classes.sh-40 aria-hidden=true tabindex=-1></a>    <span class=va>assoc</span><span class=op>[</span><span class=va>$c</span><span class=op>]=</span><span class=va>$sn</span></span>
<span id=optim-classes.sh-41><a href=#optim-classes.sh-41 aria-hidden=true tabindex=-1></a>    <span class=kw>((</span><span class=va>i</span><span class=op>++</span><span class=kw>))</span></span>
<span id=optim-classes.sh-42><a href=#optim-classes.sh-42 aria-hidden=true tabindex=-1></a><span class=cf>done</span></span>
<span id=optim-classes.sh-43><a href=#optim-classes.sh-43 aria-hidden=true tabindex=-1></a></span>
<span id=optim-classes.sh-44><a href=#optim-classes.sh-44 aria-hidden=true tabindex=-1></a><span class=va>htmlreplacer</span><span class=op>=</span><span class=st>&#39;&#39;</span></span>
<span id=optim-classes.sh-45><a href=#optim-classes.sh-45 aria-hidden=true tabindex=-1></a><span class=va>cssreplacer</span><span class=op>=</span><span class=st>&#39;&#39;</span></span>
<span id=optim-classes.sh-46><a href=#optim-classes.sh-46 aria-hidden=true tabindex=-1></a><span class=cf>for</span> long <span class=kw>in</span> <span class=va>$classes</span><span class=kw>;</span> <span class=cf>do</span></span>
<span id=optim-classes.sh-47><a href=#optim-classes.sh-47 aria-hidden=true tabindex=-1></a>    <span class=va>htmlreplacer</span><span class=op>=</span><span class=va>$htmlreplacer</span><span class=st>&#39;s#class=(&quot;?)&#39;</span><span class=va>${long}</span><span class=st>&#39;#class=$1&#39;</span><span class=va>${assoc</span><span class=op>[</span><span class=va>$long</span><span class=op>]</span><span class=va>}</span><span class=st>&#39;#g;&#39;</span></span>
<span id=optim-classes.sh-48><a href=#optim-classes.sh-48 aria-hidden=true tabindex=-1></a>    <span class=va>cssreplacer</span><span class=op>=</span><span class=va>$cssreplacer</span><span class=st>&#39;s#\.&#39;</span><span class=va>${long}</span><span class=st>&#39;#.&#39;</span><span class=va>${assoc</span><span class=op>[</span><span class=va>$long</span><span class=op>]</span><span class=va>}</span><span class=st>&#39;#g;&#39;</span></span>
<span id=optim-classes.sh-49><a href=#optim-classes.sh-49 aria-hidden=true tabindex=-1></a><span class=cf>done</span></span>
<span id=optim-classes.sh-50><a href=#optim-classes.sh-50 aria-hidden=true tabindex=-1></a></span>
<span id=optim-classes.sh-51><a href=#optim-classes.sh-51 aria-hidden=true tabindex=-1></a><span class=fu>sizeof()</span> <span class=kw>{</span></span>
<span id=optim-classes.sh-52><a href=#optim-classes.sh-52 aria-hidden=true tabindex=-1></a>    <span class=fu>stat</span> <span class=at>--format</span><span class=op>=</span><span class=st>&quot;%s&quot;</span> <span class=st>&quot;</span><span class=va>$*</span><span class=st>&quot;</span></span>
<span id=optim-classes.sh-53><a href=#optim-classes.sh-53 aria-hidden=true tabindex=-1></a><span class=kw>}</span></span>
<span id=optim-classes.sh-54><a href=#optim-classes.sh-54 aria-hidden=true tabindex=-1></a></span>
<span id=optim-classes.sh-55><a href=#optim-classes.sh-55 aria-hidden=true tabindex=-1></a><span class=cf>for</span> fic <span class=kw>in</span> <span class=va>$webdir</span>/<span class=pp>**</span>/<span class=pp>*</span>.<span class=dt>{html</span><span class=op>,</span><span class=dt>xml}</span><span class=er>(</span><span class=ex>N</span><span class=kw>);</span> <span class=cf>do</span></span>
<span id=optim-classes.sh-56><a href=#optim-classes.sh-56 aria-hidden=true tabindex=-1></a>    <span class=va>before</span><span class=op>=</span><span class=va>$(</span><span class=ex>sizeof</span> <span class=va>$fic)</span></span>
<span id=optim-classes.sh-57><a href=#optim-classes.sh-57 aria-hidden=true tabindex=-1></a>    <span class=ex>print</span> <span class=at>-n</span> <span class=at>--</span> <span class=st>&quot;</span><span class=va>$fic</span><span class=st> (</span><span class=va>$before</span><span class=st>&quot;</span></span>
<span id=optim-classes.sh-58><a href=#optim-classes.sh-58 aria-hidden=true tabindex=-1></a>    <span class=fu>perl</span> <span class=at>-pi</span> <span class=at>-e</span> <span class=va>$htmlreplacer</span> <span class=va>$fic</span></span>
<span id=optim-classes.sh-59><a href=#optim-classes.sh-59 aria-hidden=true tabindex=-1></a>    <span class=va>after</span><span class=op>=</span><span class=va>$(</span><span class=ex>sizeof</span> <span class=va>$fic)</span></span>
<span id=optim-classes.sh-60><a href=#optim-classes.sh-60 aria-hidden=true tabindex=-1></a>    <span class=ex>print</span> <span class=at>--</span> <span class=st>&quot; =&gt; </span><span class=va>$after</span><span class=st> [</span><span class=va>$((</span> ((<span class=va>before</span> <span class=op>-</span> <span class=va>after</span>) <span class=op>*</span> <span class=dv>100</span>) <span class=op>/</span> <span class=va>before</span>  <span class=va>))</span><span class=st>])&quot;</span></span>
<span id=optim-classes.sh-61><a href=#optim-classes.sh-61 aria-hidden=true tabindex=-1></a><span class=cf>done</span></span>
<span id=optim-classes.sh-62><a href=#optim-classes.sh-62 aria-hidden=true tabindex=-1></a><span class=cf>for</span> fic <span class=kw>in</span> <span class=va>$webdir</span>/<span class=pp>**</span>/<span class=pp>*</span>.css<span class=er>(</span><span class=ex>N</span><span class=kw>);</span> <span class=cf>do</span></span>
<span id=optim-classes.sh-63><a href=#optim-classes.sh-63 aria-hidden=true tabindex=-1></a>    <span class=va>before</span><span class=op>=</span><span class=va>$(</span><span class=ex>sizeof</span> <span class=va>$fic)</span></span>
<span id=optim-classes.sh-64><a href=#optim-classes.sh-64 aria-hidden=true tabindex=-1></a>    <span class=ex>print</span> <span class=at>-n</span> <span class=at>--</span> <span class=st>&quot;</span><span class=va>$fic</span><span class=st> (</span><span class=va>$before</span><span class=st>&quot;</span></span>
<span id=optim-classes.sh-65><a href=#optim-classes.sh-65 aria-hidden=true tabindex=-1></a>    <span class=fu>perl</span> <span class=at>-pi</span>  <span class=at>-e</span> <span class=va>$cssreplacer</span> <span class=va>$fic</span></span>
<span id=optim-classes.sh-66><a href=#optim-classes.sh-66 aria-hidden=true tabindex=-1></a>    <span class=va>after</span><span class=op>=</span><span class=va>$(</span><span class=ex>sizeof</span> <span class=va>$fic)</span></span>
<span id=optim-classes.sh-67><a href=#optim-classes.sh-67 aria-hidden=true tabindex=-1></a>    <span class=ex>print</span> <span class=at>--</span> <span class=st>&quot; =&gt; </span><span class=va>$after</span><span class=st> [</span><span class=va>$((</span> ((<span class=va>before</span> <span class=op>-</span> <span class=va>after</span>) <span class=op>*</span> <span class=dv>100</span>) <span class=op>/</span> <span class=va>before</span>  <span class=va>))</span><span class=st>])&quot;</span></span>
<span id=optim-classes.sh-68><a href=#optim-classes.sh-68 aria-hidden=true tabindex=-1></a><span class=cf>done</span></span></code></pre></div><p>A few remarks:<ul><li>to prevent doing the work twice, the script only takes care for classe names longer or equal to 3 chars. (<code class=w>awk 'length($2)>2 {print
length($2),$2}'</code>). As consequence take care that your website does not use class name shorter than 3 chars otherwise it could mess with your css.<li>The script do not change ids because those can be used for anchors and thus can be part of public URLs.<li>The script replace the classes with the longuest name first to prevent bug if one class name is a prefix of another one.<li>We generate a long perl script to launch perl just once, this make the full find and replace way faster.</ul><p>Of course this could be improved by providing the shortest name to the most used classes, and also by using a better <code class=w>shortName</code> function that could use more chars. But just this quick and dirty script already does a better work than existing methods that do not take into account all the CSS and HTML files.<p><footer><i>Any comment? Click on my email below and I'll add it.</i><table><tbody><tr class=ct><td>author<td><span class=bc><a href="mailto:Yann Esposito <yann@esposito.host>?subject=yblog: Optimize the size of no js websites" class=bo>Yann Esposito &lt;yann@esposito.host></a></span><tr class=cg><td>gpg<td><a href=files/publickey.txt>CB420F8005F1A662</a><tr class=ct><td>tags<td><tr class=cg><td>date<td>2019-12-06<tr class=ct><td>rss<td><a href=/rss.xml>RSS</a> (<a href="https://validator.w3.org/feed/check.cgi?url=https%3A%2F%2Fher.esy.fun%2Frss.xml">validate</a>)<tr class=cg><td>size<td><span class=web-file-size> 28K (html 22K, css 5.9K)</span><tr class=ct><td>gz<td><span class=gzweb-file-size> 6.0K (html 4.1K, css 2.0K)</span><tr class=cg><td>generated<td>2021-04-18T10:16:08.318225Z</table><p></footer></p><br><a href=gemini://her.esy.fun/posts/0009-optim-nojs-website/index.gmi><code>=> This article is also available on gemini</code></a></div><div id=postamble class=aq><div class=ak><nav><a href=/index.html>Home</a> |
<a href=/slides.html>Slides</a> |
<a href=/about-me.html>About</a>
<span class=ai>(<a href=https://gitea.esy.fun/yogsototh>code</a>
<a href=https://espial.esy.fun/u:yogsototh>bookmarks</a>
<a href=https://espial.esy.fun/u:yogsototh/notes>notes</a>)</span> |
<a href=#preamble>↑ Top ↑</a></nav></div></div></div>