<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Static Blog Builder</title><meta name=author content="Yann Esposito"><meta name=description content="Minimal and fast static website builder with make."><meta name=keywords content="blog static"><link rel=stylesheet href=/css/y.css><link rel=alternate type=application/rss+xml href=/rss.xml><link rel=icon href=/favicon.ico><div class=main><div id=preamble class=status><div class=content><div id=logo><a href=/><svg width="5em" viewBox="0 0 64 64"><circle cx="32" cy="32" r="30" stroke="var(--b2)" stroke-width="2" fill="var(--b03)"/><circle cx="32" cy="32" r="12" stroke="var(--r)" stroke-width="2" fill="var(--o)"/><circle cx="32" cy="32" r="6" stroke-width="0" fill="var(--y)"/><ellipse cx="32" cy="14" rx="14" ry="8" stroke-width="0" fill="var(--b3)"/></svg></a></div><h1>Static Blog Builder</h1><div class=meta><span class=yyydate>[2021-05-01 Sat]</span> on
<a href=https://her.esy.fun><span class=author>Yann Esposito</span>'s blog</a></div><div class=abstract>Minimal and fast static website builder with make.</div></div></div><div id=content><p>As someone on the Internet said not so far ago. Building its own static building system is a rite of passage for many developers. It has a lot of nice features. It gives a goal with a feeling of accomplishment. It is simple enough so most developers could build their own system. But it could also become very complex when you go down the rabbit hole.<p>Along the years I used different tools and used and wrote of few static website systems:<ul><li><a href=https://nanoc.app>nanoc</a> (in Ruby), at that time it looked like this: <a href=https://web.archive.org/web/20081002071448/http://nanoc.stoneship.org/>old nanoc 2 website</a><li><a href=https://jaspervdj.be/hakyll/>hakyll</a> (haskell static website generator)<li><a href=https://orgmode.org/worg/org-tutorials/org-publish-html-tutorial.html>org-publish</a> (emacs package in conjunction with org-mode)<li><a href=https://shakebuild.com>shake</a> (haskell again)</ul><p>So if you look at the progression, I first used nanoc because I used ruby and it was a very new solution, the website looked really great. Also the main developer <a href=https://denisdefreyne.com>Denis Defreyne</a> was really helpful. Ruby was really great at dealing with regular expressions for hacking my documents.<p>Then I was interested in Haskell, and I switched to a Haskell-made solution. I used hakyll, and I wrote a bit about it in <a href=http://yannesposito.com/Scratch/en/blog/Hakyll-setup/>Hakyll Setup</a>. As a side note, the author of Hakyll <a href=https://jaspervdj.be/hakyll/>Jasper Van der Jeugt</a> is apparently a friend of the author of nanoc. They both wrote a static site generators with their preferred programming language. I added a lot of personal features to my own site builder. It was a nice toy project.<p>Then, due to a major disruption in my professional and private life I stopped to take care of my website.<p>And a few years ago, I wanted to start a new website from scratch. In the meantime I switched my editor of choice from vim to Emacs. I started to work in Clojure and emacs is generally a natural choice because you can configure it with LISP. I discovered <a href=https://orgmode.org/worg/org-tutorials/org-publish-html-tutorial.html>org-mode</a> (I don't think the homepage of org mode makes justice to how incredible it is). So org-mode comes with an export system. Thus I switched to org-publish. Again <a href=https://her.esy.fun/posts/0001-new-blog/index.html>I wrote a bit about it</a>.<p>It was nice, but very slow. I improved a few things like writing a short script to <a href=https://her.esy.fun/posts/0005-rss-gen/index.html>Generate RSS from a tree of html files.</a> But I still had the feeling it was too slow.<p>Static site building is a specific usage of a build system. And as I knew I could use <code class=verbatim>pandoc</code> to build HTML out of org-mode files and still versed in the Haskell culture I decided to try <a href=https://shakebuild.com>shake</a>. You can learn more by reading this excellent paper about it, I think all developer should read it: <a href=https://github.com/snowleopard/build-systems/releases/download/icfp-submission/build-systems.pdf>Build System à la carte</a>.<p>As a bonus, <a href=https://pandoc.org>pandoc</a> is written in Haskell. I could then directly use the <a href=https://pandoc.org>pandoc</a> library in my build program. It worked like a charm and it was <strong>very fast</strong> as compared to other solutions I tried. So really let me tell you shake is a great build system.<p>But it was not perfect. While it was very fast, and I was able to use pandoc API directly. It made me dependent on Haskell. The best way I found to have Haskell reproducible build environment is to use <a href=https://nixos.org/nix>nix</a>. This was great until the Big Sur update. To keep it short, nix stopped working on my computers after I upgraded my to Big Sur. Gosh, it was painful to fix.<p>Concurrently I discovered <a href=file:///posts/0016-gemini/index.html>gemini</a> and wanted to duplicate my website into gemini sphere. So I tried to update my build system but my code was to oriented to use pandoc and it was painful to have gemini in the middle of it. Particularly, generating a gemini index file. My main goal was to have gemini file that could only be linked from withing gemini sphere. Because gemini is a lot smaller web where you could feel a bit more protected from what the Web has become along the years. Whatever, in the end, I just had two problems to tackles.<ol><li>Haskell became difficult to trust as very stable tool. Stable in the sense that I would not have any support work to do in order to keep just using it and not fixing/tweaking it.<li>Simplify the overall system to have a simpler build description</ol><p>So a very stable tool that I am pretty sure will still work almost exactly as today in 10 years is <strong><code class=verbatim>make</code></strong> (more precisely gnumake). I expected a lot of people had already come to the same conclusion and wrote about it. To my great surprise, I found very few article about generating static website with make. I only found solutions a bit too specific for my need. This is why I would like to give you a more generic starting point solution.<h1 id=the--makefile->The <code class=verbatim>Makefile</code></h1><p>Instead of copy/pasting my current <code class=verbatim>Makefile</code> entirely let me give you a more generic one. It should be a great start.<p>The first part will be used to simply copy the files from <code class=verbatim>src/</code> to <code class=verbatim>_site/</code>.<div class=sourceCode id=cb1><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id=cb1-1><a href=#cb1-1 aria-hidden=true tabindex=-1></a><span class=dv>all:</span><span class=dt> website</span></span>
<span id=cb1-2><a href=#cb1-2 aria-hidden=true tabindex=-1></a></span>
<span id=cb1-3><a href=#cb1-3 aria-hidden=true tabindex=-1></a><span class=co># directory containing my org files as well as my assets files</span></span>
<span id=cb1-4><a href=#cb1-4 aria-hidden=true tabindex=-1></a><span class=dt>SRC_DIR </span><span class=ch>?=</span><span class=st> src</span></span>
<span id=cb1-5><a href=#cb1-5 aria-hidden=true tabindex=-1></a><span class=co># directory where I will but the files for my website (HTML + assets)</span></span>
<span id=cb1-6><a href=#cb1-6 aria-hidden=true tabindex=-1></a><span class=dt>DST_DIR </span><span class=ch>?=</span><span class=st> _site</span></span>
<span id=cb1-7><a href=#cb1-7 aria-hidden=true tabindex=-1></a></span>
<span id=cb1-8><a href=#cb1-8 aria-hidden=true tabindex=-1></a><span class=co># list all files in src</span></span>
<span id=cb1-9><a href=#cb1-9 aria-hidden=true tabindex=-1></a><span class=co># if you want to exclude .org files use the exclude from the find command</span></span>
<span id=cb1-10><a href=#cb1-10 aria-hidden=true tabindex=-1></a><span class=dt>SRC_RAW_FILES </span><span class=ch>:=</span><span class=st> </span><span class=ch>$(</span><span class=kw>shell</span><span class=st> find </span><span class=ch>$(</span><span class=dt>SRC_DIR</span><span class=ch>)</span><span class=st> -type f</span><span class=ch>)</span></span>
<span id=cb1-11><a href=#cb1-11 aria-hidden=true tabindex=-1></a><span class=co># generate all file that should be copied in the site</span></span>
<span id=cb1-12><a href=#cb1-12 aria-hidden=true tabindex=-1></a><span class=co># For my site, I want to publish my source files along the HTML files</span></span>
<span id=cb1-13><a href=#cb1-13 aria-hidden=true tabindex=-1></a><span class=dt>DST_RAW_FILES   </span><span class=ch>:=</span><span class=st> </span><span class=ch>$(</span><span class=kw>patsubst</span><span class=st> </span><span class=ch>$(</span><span class=dt>SRC_DIR</span><span class=ch>)</span><span class=st>/%</span><span class=kw>,</span><span class=ch>$(</span><span class=dt>DST_DIR</span><span class=ch>)</span><span class=st>/%</span><span class=kw>,</span><span class=ch>$(</span><span class=dt>SRC_RAW_FILES</span><span class=ch>))</span></span>
<span id=cb1-14><a href=#cb1-14 aria-hidden=true tabindex=-1></a><span class=dt>ALL             </span><span class=ch>+=</span><span class=st> </span><span class=ch>$(</span><span class=dt>DST_RAW_FILES</span><span class=ch>)</span></span>
<span id=cb1-15><a href=#cb1-15 aria-hidden=true tabindex=-1></a></span>
<span id=cb1-16><a href=#cb1-16 aria-hidden=true tabindex=-1></a><span class=co># COPY EVERYTHING (.org file included)</span></span>
<span id=cb1-17><a href=#cb1-17 aria-hidden=true tabindex=-1></a><span class=dv>$(DST_DIR)/% :</span><span class=dt> </span><span class=ch>$(</span><span class=dt>SRC_DIR</span><span class=ch>)</span><span class=dt>/%</span></span>
<span id=cb1-18><a href=#cb1-18 aria-hidden=true tabindex=-1></a>    mkdir -p <span class=st>&quot;</span><span class=ch>$(</span><span class=kw>dir</span><span class=st> </span><span class=ch>$@)</span><span class=st>&quot;</span></span>
<span id=cb1-19><a href=#cb1-19 aria-hidden=true tabindex=-1></a>    cp <span class=st>&quot;</span><span class=ch>$&lt;</span><span class=st>&quot;</span> <span class=st>&quot;</span><span class=ch>$@</span><span class=st>&quot;</span></span></code></pre></div><p>This part is about running the <code class=verbatim>pandoc</code> command for all <code class=verbatim>org</code> files in <code class=verbatim>src/</code> so they generate a html file in <code class=verbatim>_site/</code>.<div class=sourceCode id=cb2><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id=cb2-1><a href=#cb2-1 aria-hidden=true tabindex=-1></a><span class=co># ORG -&gt; HTML, If you prefer markdown replace .org by .md</span></span>
<span id=cb2-2><a href=#cb2-2 aria-hidden=true tabindex=-1></a><span class=dt>EXT </span><span class=ch>:=</span><span class=st> .org</span></span>
<span id=cb2-3><a href=#cb2-3 aria-hidden=true tabindex=-1></a><span class=co># all source file we&#39;ll pass to pandoc</span></span>
<span id=cb2-4><a href=#cb2-4 aria-hidden=true tabindex=-1></a><span class=dt>SRC_PANDOC_FILES </span><span class=ch>?=</span><span class=st> </span><span class=ch>$(</span><span class=kw>shell</span><span class=st> find </span><span class=ch>$(</span><span class=dt>SRC_DIR</span><span class=ch>)</span><span class=st> -type f -name &quot;*</span><span class=ch>$(</span><span class=dt>EXT</span><span class=ch>)</span><span class=st>&quot;</span><span class=ch>)</span></span>
<span id=cb2-5><a href=#cb2-5 aria-hidden=true tabindex=-1></a><span class=co># all destination files we expect (replace the extension by .html)</span></span>
<span id=cb2-6><a href=#cb2-6 aria-hidden=true tabindex=-1></a><span class=dt>DST_PANDOC_FILES </span><span class=ch>?=</span><span class=st> </span><span class=ch>$(</span><span class=kw>subst</span><span class=st> </span><span class=ch>$(</span><span class=dt>EXT</span><span class=ch>)</span><span class=kw>,</span><span class=st>.html</span><span class=kw>,</span><span class=st> \</span></span>
<span id=cb2-7><a href=#cb2-7 aria-hidden=true tabindex=-1></a><span class=st>                        </span><span class=ch>$(</span><span class=kw>subst</span><span class=st> </span><span class=ch>$(</span><span class=dt>SRC_DIR</span><span class=ch>)</span><span class=kw>,</span><span class=ch>$(</span><span class=dt>DST_DIR</span><span class=ch>)</span><span class=kw>,</span><span class=st> \</span></span>
<span id=cb2-8><a href=#cb2-8 aria-hidden=true tabindex=-1></a><span class=st>                            </span><span class=ch>$(</span><span class=dt>SRC_PANDOC_FILES</span><span class=ch>)))</span></span>
<span id=cb2-9><a href=#cb2-9 aria-hidden=true tabindex=-1></a><span class=dt>ALL              </span><span class=ch>+=</span><span class=st> </span><span class=ch>$(</span><span class=dt>DST_PANDOC_FILES</span><span class=ch>)</span></span>
<span id=cb2-10><a href=#cb2-10 aria-hidden=true tabindex=-1></a></span>
<span id=cb2-11><a href=#cb2-11 aria-hidden=true tabindex=-1></a><span class=co># use a template (you should use one)</span></span>
<span id=cb2-12><a href=#cb2-12 aria-hidden=true tabindex=-1></a><span class=dt>TEMPLATE </span><span class=ch>?=</span><span class=st> templates/post.html</span></span>
<span id=cb2-13><a href=#cb2-13 aria-hidden=true tabindex=-1></a><span class=co># URL of the CSS put yours</span></span>
<span id=cb2-14><a href=#cb2-14 aria-hidden=true tabindex=-1></a><span class=dt>CSS </span><span class=ch>=</span><span class=st> /css/y.css</span></span>
<span id=cb2-15><a href=#cb2-15 aria-hidden=true tabindex=-1></a><span class=co># The pandoc command to run to generate an html out of a source file</span></span>
<span id=cb2-16><a href=#cb2-16 aria-hidden=true tabindex=-1></a><span class=dt>PANDOC </span><span class=ch>:=</span><span class=st> pandoc </span><span class=ch>\</span></span>
<span id=cb2-17><a href=#cb2-17 aria-hidden=true tabindex=-1></a><span class=st>            -c </span><span class=ch>$(</span><span class=dt>CSS</span><span class=ch>)</span><span class=st> </span><span class=ch>\</span></span>
<span id=cb2-18><a href=#cb2-18 aria-hidden=true tabindex=-1></a><span class=st>            --template=</span><span class=ch>$(</span><span class=dt>TEMPLATE</span><span class=ch>)</span><span class=st> </span><span class=ch>\</span></span>
<span id=cb2-19><a href=#cb2-19 aria-hidden=true tabindex=-1></a><span class=st>            --from org </span><span class=ch>\</span></span>
<span id=cb2-20><a href=#cb2-20 aria-hidden=true tabindex=-1></a><span class=st>            --to html5 </span><span class=ch>\</span></span>
<span id=cb2-21><a href=#cb2-21 aria-hidden=true tabindex=-1></a><span class=st>            --standalone</span></span>
<span id=cb2-22><a href=#cb2-22 aria-hidden=true tabindex=-1></a></span>
<span id=cb2-23><a href=#cb2-23 aria-hidden=true tabindex=-1></a><span class=co># Generate all html if the org file change or the template change</span></span>
<span id=cb2-24><a href=#cb2-24 aria-hidden=true tabindex=-1></a><span class=dv>$(DST_DIR)/%.html:</span><span class=dt> </span><span class=ch>$(</span><span class=dt>SRC_DIR</span><span class=ch>)</span><span class=dt>/%.org </span><span class=ch>$(</span><span class=dt>TEMPLATE</span><span class=ch>)</span></span>
<span id=cb2-25><a href=#cb2-25 aria-hidden=true tabindex=-1></a>    mkdir -p <span class=ch>$(</span><span class=kw>dir</span><span class=st> </span><span class=ch>$@)</span></span>
<span id=cb2-26><a href=#cb2-26 aria-hidden=true tabindex=-1></a>    <span class=ch>$(</span><span class=dt>PANDOC</span><span class=ch>)</span> <span class=ch>$&lt;</span> <span class=ch>\</span></span>
<span id=cb2-27><a href=#cb2-27 aria-hidden=true tabindex=-1></a>        --output <span class=ch>$@</span></span>
<span id=cb2-28><a href=#cb2-28 aria-hidden=true tabindex=-1></a></span></code></pre></div><p>A missing part is often the part where you would like to generate an index page to list the latest posts. Here you are a bit alone, you need to make one yourself. There is not generic way to do this one.<div class=sourceCode id=cb3><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id=cb3-1><a href=#cb3-1 aria-hidden=true tabindex=-1></a><span class=co># Generating an index page is not difficult but not trivial either</span></span>
<span id=cb3-2><a href=#cb3-2 aria-hidden=true tabindex=-1></a><span class=dt>HTML_INDEX </span><span class=ch>:=</span><span class=st> </span><span class=ch>$(</span><span class=dt>DST_DIR</span><span class=ch>)</span><span class=st>/index.html</span></span>
<span id=cb3-3><a href=#cb3-3 aria-hidden=true tabindex=-1></a><span class=dt>MKINDEX </span><span class=ch>:=</span><span class=st> engine/mk-index.sh</span></span>
<span id=cb3-4><a href=#cb3-4 aria-hidden=true tabindex=-1></a><span class=dv>$(HTML_INDEX):</span><span class=dt> </span><span class=ch>$(</span><span class=dt>DST_PANDOC_FILES</span><span class=ch>)</span><span class=dt> </span><span class=ch>$(</span><span class=dt>MKINDEX</span><span class=ch>)</span></span>
<span id=cb3-5><a href=#cb3-5 aria-hidden=true tabindex=-1></a>    mkdir -p <span class=ch>$(</span><span class=dt>DST_DIR</span><span class=ch>)</span></span>
<span id=cb3-6><a href=#cb3-6 aria-hidden=true tabindex=-1></a>    <span class=ch>$(</span><span class=dt>MKINDEX</span><span class=ch>)</span></span>
<span id=cb3-7><a href=#cb3-7 aria-hidden=true tabindex=-1></a><span class=dt>ALL </span><span class=ch>+=</span><span class=st> </span><span class=ch>$(</span><span class=dt>HTML_INDEX</span><span class=ch>)</span></span></code></pre></div><p>Finally, a few useful make commands. <code class=verbatim>make clean</code> and <code class=verbatim>make deploy</code>.<div class=sourceCode id=cb4><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id=cb4-1><a href=#cb4-1 aria-hidden=true tabindex=-1></a><span class=co># make deploy will deploy the files to my website write your own script</span></span>
<span id=cb4-2><a href=#cb4-2 aria-hidden=true tabindex=-1></a><span class=dv>deploy:</span><span class=dt> </span><span class=ch>$(</span><span class=dt>ALL</span><span class=ch>)</span></span>
<span id=cb4-3><a href=#cb4-3 aria-hidden=true tabindex=-1></a>    engine/deploy.sh</span>
<span id=cb4-4><a href=#cb4-4 aria-hidden=true tabindex=-1></a></span>
<span id=cb4-5><a href=#cb4-5 aria-hidden=true tabindex=-1></a><span class=dv>website:</span><span class=dt> </span><span class=ch>$(</span><span class=dt>ALL</span><span class=ch>)</span></span>
<span id=cb4-6><a href=#cb4-6 aria-hidden=true tabindex=-1></a></span>
<span id=cb4-7><a href=#cb4-7 aria-hidden=true tabindex=-1></a><span class=ot>.PHONY:</span><span class=dt> clean</span></span>
<span id=cb4-8><a href=#cb4-8 aria-hidden=true tabindex=-1></a></span>
<span id=cb4-9><a href=#cb4-9 aria-hidden=true tabindex=-1></a><span class=dv>clean:</span></span>
<span id=cb4-10><a href=#cb4-10 aria-hidden=true tabindex=-1></a>    <span class=ch>-</span><span class=fu>rm -rf </span><span class=ch>$(</span><span class=dt>DST_DIR</span><span class=ch>)</span><span class=fu>/*</span></span></code></pre></div><p>Limitation: <code class=verbatim>make</code> is old. So it really does not support spaces in filenames. Take care of that.<p>But let me tell you. While this is quite a minimalist approach (&lt;100 lines) it is nevertheless <strong>very fast</strong>. It will only generate the minimal amount of work to generate your website. I have a nice watcher script that update the website every time I save a file. It is almost instantaneous.<p>The only risky dependencies for my website now is <code class=verbatim>pandoc</code>. Perhaps, they will change how they generate an HTML from the same org file in the future. I still use <code class=verbatim>nix</code> to pin my pandoc version. But the static site builder itself is very simple, very stable and still very efficient.<p>As a conclusion, if you want to write your own static site builder that's great. There are plenty of things to learn along the way. Still if you want something stable for a long time, with a minimal amount of dependencies, I think this Makefile is really a great start.</div><div id=postamble class=status><div class=content><nav><a href=/index.html>Home</a> |
<a href=/slides.html>Slides</a> |
<a href=/about-me.html>About</a>
<span class=details>(<a href=https://gitea.esy.fun/yogsototh>code</a>
<a href=https://espial.esy.fun/u:yogsototh>bookmarks</a>
<a href=https://espial.esy.fun/u:yogsototh/notes>notes</a>)</span> |
<a href=#preamble>↑ Top ↑</a></nav></div></div></div>