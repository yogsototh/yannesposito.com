<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Autoload Script by project</title><meta name=author content="Yann Esposito"><meta name=description content="A script I use to load safely an eLISP file when entering a new project directory."><meta name=keywords content="programming blog org-mode"><link rel=stylesheet href=/css/y.css><link rel=alternate type=application/rss+xml href=/rss.xml><link rel=icon href=/favicon.ico><meta name=theme-color media="(prefers-color-scheme: light)" content="#d84100"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#2E3440"><div class=main><div id=logo><a href=/ title="logo, back to root page"><svg width="5em" viewBox="0 0 64 64"><circle cx="32" cy="32" r="30" stroke="#a3aec2" stroke-width="1" fill="#2e3440"/><circle cx="32" cy="32" r="12" stroke="#800" stroke-width="1" fill="#c20"/><circle cx="32" cy="32" r="5" stroke-width="1" stroke="#f60" fill="#fa0"/><ellipse cx="32" cy="14" rx="14" ry="8" stroke-width="0" fill="#fff"/></svg></a></div><header id=preamble class=status role=banner><div class=content><h1>Autoload Script by project</h1><div class=meta><span class=yyydate>[2019-08-18 Sun]</span> on
<a href=https://her.esy.fun><span class=author>Yann Esposito</span>'s blog</a></div><div class=abstract>A script I use to load safely an eLISP file when entering a new project directory.</div></div></header><main id=content role=main><article><blockquote><p><em>tl;dr</em>: A script that use projectile and GPG to securely load an emacs lisp script when opening a new project.<p>Check the <a href=#solution>#solution</a> section to get the code.</blockquote><h1 id=problem>Problem</h1><p>When providing a repository containing only org files of my blog. I also wanted to provide everything necessary for users to be able to publish my website. Emacs, org-publish mostly assume you should put all those details in a centralised place in your <code>~/.emacs.d/.init.el</code> file.<p>The main principle is quite simple.<ol><li>When opening a new file in a project, check for the presence of a <code>project.el</code> and <code>project.el.sig</code> file at the root directory of the project.<li>Check the file was signed with by a trusted fingerprint.<li>Load the file.</ol><p>Other solutions I found on the internet asked you each time you enter in a project if you trust the file or not. This was both quite annoying and insecure as it is kind of easy to type 'y' instead of 'n' and to load 3rd party script.<p>Note that checking who signed a file with an external signature is not as straightforward as it should be:<div class=sourceCode id=cb1 data-org-language=lisp><pre class="sourceCode commonlisp"><code class="sourceCode commonlisp"><span id=cb1-1><a href=#cb1-1 aria-hidden=true></a>(<span class=kw>defun</span><span class=fu> auto-load-project/get-sign-key </span>(file)</span>
<span id=cb1-2><a href=#cb1-2 aria-hidden=true></a>  <span class=st>&quot;Return the fingerprint of they key that signed FILE.</span></span>
<span id=cb1-3><a href=#cb1-3 aria-hidden=true></a></span>
<span id=cb1-4><a href=#cb1-4 aria-hidden=true></a><span class=st>To sign a file you should used</span></span>
<span id=cb1-5><a href=#cb1-5 aria-hidden=true></a></span>
<span id=cb1-6><a href=#cb1-6 aria-hidden=true></a><span class=st>`gpg --local-user my@email --output project.el.sig --detach-sign project.el`&quot;</span></span>
<span id=cb1-7><a href=#cb1-7 aria-hidden=true></a>  (string-trim-right</span>
<span id=cb1-8><a href=#cb1-8 aria-hidden=true></a>   (shell-command-to-string</span>
<span id=cb1-9><a href=#cb1-9 aria-hidden=true></a>    (concat</span>
<span id=cb1-10><a href=#cb1-10 aria-hidden=true></a>     (<span class=kw>format</span> <span class=st>&quot;gpg --status-fd 1 --verify %s.sig %s 2&gt;/dev/null &quot;</span> file file)</span>
<span id=cb1-11><a href=#cb1-11 aria-hidden=true></a>     <span class=st>&quot;|grep VALIDSIG&quot;</span></span>
<span id=cb1-12><a href=#cb1-12 aria-hidden=true></a>     <span class=st>&quot;|awk &#39;{print $3}&#39;&quot;</span>))))</span></code></pre></div><ul><li>The `â€“status-fd` should provide more script friendly output. GPG provide localized output by default which are therefore hard to use in script (for grep for example).</ul><p>We use <code>projectile</code> to detect the project-root and when we are in a new project. Unfortunately the <code>projectile-after-switch-project-hooks</code> doesn't work as I expected. So I use the hooks <code>find-file-hook</code> and <code>dired-mode-hook</code> to try to load the file. In order not to load the code each time, I need to keep a local state of project already loaded.<p>So now, each time I modify the <code>project.el</code> I sign it with the following command line:<div class=sourceCode id=cb2><pre class="sourceCode bash"><code class="sourceCode bash"><span id=cb2-1><a href=#cb2-1 aria-hidden=true></a><span class=ex>gpg</span> --local-user my@email --output project.el.sig --detach-sign project.el</span></code></pre></div><h1 id=solution>Solution</h1><p>The project is hosted here: <a href=https://gitlab.esy.fun/yogsototh/auto-load-project-el>https://gitlab.esy.fun/yogsototh/auto-load-project-el</a><p>You can setup the emacs package in spacemacs with:<div class=sourceCode id=cb3 data-org-language=lisp><pre class="sourceCode commonlisp"><code class="sourceCode commonlisp"><span id=cb3-1><a href=#cb3-1 aria-hidden=true></a><span class=co>;; ...</span></span>
<span id=cb3-2><a href=#cb3-2 aria-hidden=true></a>dotspacemacs-additional-packages</span>
<span id=cb3-3><a href=#cb3-3 aria-hidden=true></a>&#39;((auto-load-project :location</span>
<span id=cb3-4><a href=#cb3-4 aria-hidden=true></a>                     (recipe</span>
<span id=cb3-5><a href=#cb3-5 aria-hidden=true></a>                      :fetcher git</span>
<span id=cb3-6><a href=#cb3-6 aria-hidden=true></a>                      :url <span class=st>&quot;https://gitlab.esy.fun/yogsototh/auto-load-project-el&quot;</span></span>
<span id=cb3-7><a href=#cb3-7 aria-hidden=true></a>                      :files (<span class=st>&quot;auto-load-project.el&quot;</span>))))</span>
<span id=cb3-8><a href=#cb3-8 aria-hidden=true></a><span class=co>;; ...</span></span>
<span id=cb3-9><a href=#cb3-9 aria-hidden=true></a>(<span class=kw>defun</span><span class=fu> dotspacemacs/user-config </span>()</span>
<span id=cb3-10><a href=#cb3-10 aria-hidden=true></a>  <span class=co>;; ...</span></span>
<span id=cb3-11><a href=#cb3-11 aria-hidden=true></a>  (<span class=kw>require</span> &#39;auto-load-project)</span>
<span id=cb3-12><a href=#cb3-12 aria-hidden=true></a>  (<span class=kw>setq</span> auto-load-project/trusted-gpg-key-fingerprints</span>
<span id=cb3-13><a href=#cb3-13 aria-hidden=true></a>        &#39;(<span class=st>&quot;0000000000000000000000000000000000000000&quot;</span></span>
<span id=cb3-14><a href=#cb3-14 aria-hidden=true></a>          <span class=st>&quot;1111111111111111111111111111111111111111&quot;</span></span>
<span id=cb3-15><a href=#cb3-15 aria-hidden=true></a>          <span class=st>&quot;2222222222222222222222222222222222222222&quot;</span></span>
<span id=cb3-16><a href=#cb3-16 aria-hidden=true></a>          )))</span>
<span id=cb3-17><a href=#cb3-17 aria-hidden=true></a><span class=co>;; ...</span></span></code></pre></div><p>The full current code should be easy to follow if you have basic notions of eLISP:<div class=sourceCode id=cb4 data-org-language=lisp><pre class="sourceCode commonlisp"><code class="sourceCode commonlisp"><span id=cb4-1><a href=#cb4-1 aria-hidden=true></a>(<span class=kw>require</span> &#39;projectile)</span>
<span id=cb4-2><a href=#cb4-2 aria-hidden=true></a></span>
<span id=cb4-3><a href=#cb4-3 aria-hidden=true></a>(<span class=kw>defvar</span><span class=fu> auto-load-project/trusted-gpg-key-fingerprints</span></span>
<span id=cb4-4><a href=#cb4-4 aria-hidden=true></a>  &#39;()</span>
<span id=cb4-5><a href=#cb4-5 aria-hidden=true></a>  <span class=st>&quot;The list of GPG fingerprint you trust when decrypting a gpg file.</span></span>
<span id=cb4-6><a href=#cb4-6 aria-hidden=true></a><span class=st>You can retrieve the fingerprints of your own private keys</span></span>
<span id=cb4-7><a href=#cb4-7 aria-hidden=true></a><span class=st>with: `gpg --list-secret-keys&#39; (take care of removing the</span></span>
<span id=cb4-8><a href=#cb4-8 aria-hidden=true></a><span class=st>spaces when copy/pasting here)&quot;</span>)</span>
<span id=cb4-9><a href=#cb4-9 aria-hidden=true></a></span>
<span id=cb4-10><a href=#cb4-10 aria-hidden=true></a>(<span class=kw>defun</span><span class=fu> auto-load-project/get-sign-key </span>(file)</span>
<span id=cb4-11><a href=#cb4-11 aria-hidden=true></a>  <span class=st>&quot;Return the fingerprint of they key that signed FILE.</span></span>
<span id=cb4-12><a href=#cb4-12 aria-hidden=true></a></span>
<span id=cb4-13><a href=#cb4-13 aria-hidden=true></a><span class=st>To sign a file you should used</span></span>
<span id=cb4-14><a href=#cb4-14 aria-hidden=true></a></span>
<span id=cb4-15><a href=#cb4-15 aria-hidden=true></a><span class=st>`gpg --local-user my@email --output project.el.sig --detach-sign project.el`&quot;</span></span>
<span id=cb4-16><a href=#cb4-16 aria-hidden=true></a>  (string-trim-right</span>
<span id=cb4-17><a href=#cb4-17 aria-hidden=true></a>   (shell-command-to-string</span>
<span id=cb4-18><a href=#cb4-18 aria-hidden=true></a>    (concat</span>
<span id=cb4-19><a href=#cb4-19 aria-hidden=true></a>     (<span class=kw>format</span> <span class=st>&quot;gpg --status-fd 1 --verify %s.sig %s 2&gt;/dev/null &quot;</span> file file)</span>
<span id=cb4-20><a href=#cb4-20 aria-hidden=true></a>     <span class=st>&quot;|grep VALIDSIG&quot;</span></span>
<span id=cb4-21><a href=#cb4-21 aria-hidden=true></a>     <span class=st>&quot;|awk &#39;{print $3}&#39;&quot;</span>))))</span>
<span id=cb4-22><a href=#cb4-22 aria-hidden=true></a></span>
<span id=cb4-23><a href=#cb4-23 aria-hidden=true></a>(<span class=kw>defun</span><span class=fu> auto-load-project/trusted-gpg-origin-p </span>(file)</span>
<span id=cb4-24><a href=#cb4-24 aria-hidden=true></a>  <span class=st>&quot;Return non-nil if the FILE is encrypted with a trusted key.&quot;</span></span>
<span id=cb4-25><a href=#cb4-25 aria-hidden=true></a>  (<span class=kw>member</span> (auto-load-project/get-sign-key file)</span>
<span id=cb4-26><a href=#cb4-26 aria-hidden=true></a>          auto-load-project/trusted-gpg-key-fingerprints))</span>
<span id=cb4-27><a href=#cb4-27 aria-hidden=true></a></span>
<span id=cb4-28><a href=#cb4-28 aria-hidden=true></a>(defconst auto-load-project/project-file <span class=st>&quot;project.el&quot;</span></span>
<span id=cb4-29><a href=#cb4-29 aria-hidden=true></a>  <span class=st>&quot;Project configuration file name.&quot;</span>)</span>
<span id=cb4-30><a href=#cb4-30 aria-hidden=true></a></span>
<span id=cb4-31><a href=#cb4-31 aria-hidden=true></a>(<span class=kw>defvar</span><span class=fu> auto-load-project/loaded-projects </span>(<span class=kw>list</span>)</span>
<span id=cb4-32><a href=#cb4-32 aria-hidden=true></a>  <span class=st>&quot;Projects that have been loaded by `auto-load-project/load&#39;.&quot;</span>)</span>
<span id=cb4-33><a href=#cb4-33 aria-hidden=true></a></span>
<span id=cb4-34><a href=#cb4-34 aria-hidden=true></a>(<span class=kw>defun</span><span class=fu> auto-load-project/load </span>()</span>
<span id=cb4-35><a href=#cb4-35 aria-hidden=true></a>  <span class=st>&quot;Loads the `auto-load-project/project-file&#39; for a project.</span></span>
<span id=cb4-36><a href=#cb4-36 aria-hidden=true></a><span class=st>This is run once the project is loaded signifying project setup.&quot;</span></span>
<span id=cb4-37><a href=#cb4-37 aria-hidden=true></a>  (interactive)</span>
<span id=cb4-38><a href=#cb4-38 aria-hidden=true></a>  (<span class=kw>when</span> (projectile-project-p)</span>
<span id=cb4-39><a href=#cb4-39 aria-hidden=true></a>    (lexical-let* ((current-project-root (projectile-project-root))</span>
<span id=cb4-40><a href=#cb4-40 aria-hidden=true></a>                   (project-init-file (expand-file-name auto-load-project/project-file current-project-root))</span>
<span id=cb4-41><a href=#cb4-41 aria-hidden=true></a>                   (project-sign-file (concat project-init-file <span class=st>&quot;.sig&quot;</span>)))</span>
<span id=cb4-42><a href=#cb4-42 aria-hidden=true></a>      (<span class=kw>when</span> (<span class=kw>and</span> (<span class=kw>not</span> (<span class=kw>member</span> current-project-root auto-load-project/loaded-projects))</span>
<span id=cb4-43><a href=#cb4-43 aria-hidden=true></a>                 (file-exists-p project-init-file)</span>
<span id=cb4-44><a href=#cb4-44 aria-hidden=true></a>                 (file-exists-p project-sign-file)</span>
<span id=cb4-45><a href=#cb4-45 aria-hidden=true></a>                 (auto-load-project/trusted-gpg-origin-p project-init-file))</span>
<span id=cb4-46><a href=#cb4-46 aria-hidden=true></a>        (message <span class=st>&quot;Loading project init file for %s&quot;</span> (projectile-project-name))</span>
<span id=cb4-47><a href=#cb4-47 aria-hidden=true></a>        (condition-case ex</span>
<span id=cb4-48><a href=#cb4-48 aria-hidden=true></a>            (<span class=kw>progn</span> (<span class=kw>load</span> project-init-file)</span>
<span id=cb4-49><a href=#cb4-49 aria-hidden=true></a>                   (add-to-list &#39;auto-load-project/loaded-projects current-project-root)</span>
<span id=cb4-50><a href=#cb4-50 aria-hidden=true></a>                   (message <span class=st>&quot;%s loaded successfully&quot;</span> project-init-file))</span>
<span id=cb4-51><a href=#cb4-51 aria-hidden=true></a>          (&#39;error</span>
<span id=cb4-52><a href=#cb4-52 aria-hidden=true></a>           (message</span>
<span id=cb4-53><a href=#cb4-53 aria-hidden=true></a>            <span class=st>&quot;There was an error loading %s: %s&quot;</span></span>
<span id=cb4-54><a href=#cb4-54 aria-hidden=true></a>            project-init-file</span>
<span id=cb4-55><a href=#cb4-55 aria-hidden=true></a>            (error-message-string ex))))))))</span>
<span id=cb4-56><a href=#cb4-56 aria-hidden=true></a></span>
<span id=cb4-57><a href=#cb4-57 aria-hidden=true></a>(add-hook &#39;find-file-hook #&#39;auto-load-project/load <span class=kw>t</span>)</span>
<span id=cb4-58><a href=#cb4-58 aria-hidden=true></a>(add-hook &#39;dired-mode-hook #&#39;auto-load-project/load <span class=kw>t</span>)</span>
<span id=cb4-59><a href=#cb4-59 aria-hidden=true></a></span>
<span id=cb4-60><a href=#cb4-60 aria-hidden=true></a>(<span class=kw>provide</span> &#39;auto-load-project)</span></code></pre></div></article></main><footer id=postamble class=status role=contentinfo><div class=content><nav role=navigation><a href=/index.html>Home</a> |
<a href=/slides.html>Slides</a> |
<a href=/about-me.html>About</a>
<span class=details>(<a href=https://gitea.esy.fun/yogsototh>code</a>
<a href=https://espial.esy.fun/u:yogsototh>bookmarks</a>
<a href=https://espial.esy.fun/u:yogsototh/notes>notes</a>)</span> |
<a href=#logo>â†‘ Top â†‘</a></nav></div></footer></div>