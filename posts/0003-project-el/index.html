<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Autoload Script by project</title><meta name=author content="Yann Esposito"><meta name=description content="A script I use to load safely an eLISP file when entering a new project directory."><meta name=keywords content="programming blog org-mode"><link rel=stylesheet href=/css/y.css><link rel=alternate type=application/rss+xml href=/rss.xml><link rel=icon href=/favicon.ico><div id=labels><div class=al><span id=logo><a href=/><svg width="5em" viewBox="0 0 64 64"><circle cx="32" cy="32" r="30" stroke="var(--b2)" stroke-width="2" fill="var(--b03)"/><circle cx="32" cy="32" r="12" stroke="var(--r)" stroke-width="2" fill="var(--o)"/><circle cx="32" cy="32" r="6" stroke-width="0" fill="var(--y)"/><ellipse cx="32" cy="14" rx="14" ry="8" stroke-width="0" fill="var(--b3)"/></svg></a></span></div></div><div class=cd><div id=preamble class=ar><div class=al><h1>Autoload Script by project</h1><div class=cb><span class=yyydate>[2019-08-18 Sun]</span> on
<a href=https://her.esy.fun><span class=bd>Yann Esposito</span>'s blog</a></div><div class=ac>A script I use to load safely an eLISP file when entering a new project directory.</div></div></div><div id=content><blockquote><p><em>tl;dr</em>: A script that use projectile and GPG to securely load an emacs lisp script when opening a new project.<p>Check the <a href=#solution>#solution</a> section to get the code.</blockquote><h1 id=problem>Problem</h1><p>When providing a repository containing only org files of my blog. I also wanted to provide everything necessary for users to be able to publish my website. Emacs, org-publish mostly assume you should put all those details in a centralised place in your <code class=w>~/.emacs.d/.init.el</code> file.<p>The main principle is quite simple.<ol><li>When opening a new file in a project, check for the presence of a <code class=w>project.el</code> and <code class=w>project.el.sig</code> file at the root directory of the project.<li>Check the file was signed with by a trusted fingerprint.<li>Load the file.</ol><p>Other solutions I found on the internet asked you each time you enter in a project if you trust the file or not. This was both quite annoying and insecure as it is kind of easy to type 'y' instead of 'n' and to load 3rd party script.<p>Note that checking who signed a file with an external signature is not as straightforward as it should be:<pre class=bp><code>(defun auto-load-project/get-sign-key (file)
  &quot;Return the fingerprint of they key that signed FILE.

To sign a file you should used

`gpg --local-user my@email --output project.el.sig --detach-sign project.el`&quot;
  (string-trim-right
   (shell-command-to-string
    (concat
     (format &quot;gpg --status-fd 1 --verify %s.sig %s 2&gt;/dev/null &quot; file file)
     &quot;|grep VALIDSIG&quot;
     &quot;|awk &#39;{print $3}&#39;&quot;))))
</code></pre><ul><li>The `–status-fd` should provide more script friendly output. GPG provide localized output by default which are therefore hard to use in script (for grep for example).</ul><p>We use <code class=w>projectile</code> to detect the project-root and when we are in a new project. Unfortunately the <code class=w>projectile-after-switch-project-hooks</code> doesn't work as I expected. So I use the hooks <code class=w>find-file-hook</code> and <code class=w>dired-mode-hook</code> to try to load the file. In order not to load the code each time, I need to keep a local state of project already loaded.<p>So now, each time I modify the <code class=w>project.el</code> I sign it with the following command line:<div class=n id=cb2><pre class="n bash"><code class="n bash"><span id=cb2-1><a href=#cb2-1 aria-hidden=true tabindex=-1></a><span class=ex>gpg</span> <span class=at>--local-user</span> my@email <span class=at>--output</span> project.el.sig <span class=at>--detach-sign</span> project.el</span></code></pre></div><h1 id=solution>Solution</h1><p>The project is hosted here: <a href=https://gitlab.esy.fun/yogsototh/auto-load-project-el>https://gitlab.esy.fun/yogsototh/auto-load-project-el</a><p>You can setup the emacs package in spacemacs with:<pre class=bp><code>;; ...
dotspacemacs-additional-packages
&#39;((auto-load-project :location
                     (recipe
                      :fetcher git
                      :url &quot;https://gitlab.esy.fun/yogsototh/auto-load-project-el&quot;
                      :files (&quot;auto-load-project.el&quot;))))
;; ...
(defun dotspacemacs/user-config ()
  ;; ...
  (require &#39;auto-load-project)
  (setq auto-load-project/trusted-gpg-key-fingerprints
        &#39;(&quot;0000000000000000000000000000000000000000&quot;
          &quot;1111111111111111111111111111111111111111&quot;
          &quot;2222222222222222222222222222222222222222&quot;
          )))
;; ...
</code></pre><p>The full current code should be easy to follow if you have basic notions of eLISP:<pre class=bp><code>(require &#39;projectile)

(defvar auto-load-project/trusted-gpg-key-fingerprints
  &#39;()
  &quot;The list of GPG fingerprint you trust when decrypting a gpg file.
You can retrieve the fingerprints of your own private keys
with: `gpg --list-secret-keys&#39; (take care of removing the
spaces when copy/pasting here)&quot;)

(defun auto-load-project/get-sign-key (file)
  &quot;Return the fingerprint of they key that signed FILE.

To sign a file you should used

`gpg --local-user my@email --output project.el.sig --detach-sign project.el`&quot;
  (string-trim-right
   (shell-command-to-string
    (concat
     (format &quot;gpg --status-fd 1 --verify %s.sig %s 2&gt;/dev/null &quot; file file)
     &quot;|grep VALIDSIG&quot;
     &quot;|awk &#39;{print $3}&#39;&quot;))))

(defun auto-load-project/trusted-gpg-origin-p (file)
  &quot;Return non-nil if the FILE is encrypted with a trusted key.&quot;
  (member (auto-load-project/get-sign-key file)
          auto-load-project/trusted-gpg-key-fingerprints))

(defconst auto-load-project/project-file &quot;project.el&quot;
  &quot;Project configuration file name.&quot;)

(defvar auto-load-project/loaded-projects (list)
  &quot;Projects that have been loaded by `auto-load-project/load&#39;.&quot;)

(defun auto-load-project/load ()
  &quot;Loads the `auto-load-project/project-file&#39; for a project.
This is run once the project is loaded signifying project setup.&quot;
  (interactive)
  (when (projectile-project-p)
    (lexical-let* ((current-project-root (projectile-project-root))
                   (project-init-file (expand-file-name auto-load-project/project-file current-project-root))
                   (project-sign-file (concat project-init-file &quot;.sig&quot;)))
      (when (and (not (member current-project-root auto-load-project/loaded-projects))
                 (file-exists-p project-init-file)
                 (file-exists-p project-sign-file)
                 (auto-load-project/trusted-gpg-origin-p project-init-file))
        (message &quot;Loading project init file for %s&quot; (projectile-project-name))
        (condition-case ex
            (progn (load project-init-file)
                   (add-to-list &#39;auto-load-project/loaded-projects current-project-root)
                   (message &quot;%s loaded successfully&quot; project-init-file))
          (&#39;error
           (message
            &quot;There was an error loading %s: %s&quot;
            project-init-file
            (error-message-string ex))))))))

(add-hook &#39;find-file-hook #&#39;auto-load-project/load t)
(add-hook &#39;dired-mode-hook #&#39;auto-load-project/load t)

(provide &#39;auto-load-project)
</code></pre></div><div id=postamble class=ar><div class=al><nav><a href=/index.html>Home</a> |
<a href=/slides.html>Slides</a> |
<a href=/about-me.html>About</a>
<span class=aj>(<a href=https://gitea.esy.fun/yogsototh>code</a>
<a href=https://espial.esy.fun/u:yogsototh>bookmarks</a>
<a href=https://espial.esy.fun/u:yogsototh/notes>notes</a>)</span> |
<a href=#preamble>↑ Top ↑</a></nav></div></div></div>