<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>A quick CORS proxy in a few lines of Clojure</title><meta name=author content="Yann Esposito"><meta name=description content><meta name=keywords content="clojure CORS web"><link rel=stylesheet href=/css/y.css><link rel=alternate type=application/rss+xml href=/rss.xml><link rel=icon href=/favicon.ico><meta name=theme-color media="(prefers-color-scheme: light)" content="#d84100"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#2E3440"><header><div id=logo><a href=/><div class=vis-hidden>Go to Home</div><svg width="5em" viewBox="0 0 64 64"><circle cx="32" cy="32" r="30" stroke="#a3aec2" stroke-width="1" fill="#2e3440"/><circle class="i1" cx="32" cy="32" r="12" stroke="#800" stroke-width="1" fill="#c20"/><circle class="i0" cx="32" cy="32" r="5" stroke-width="1" stroke="#f60" fill="#fa0"/><ellipse class="e" cx="32" cy="14" rx="14" ry="8" stroke-width="0" fill="#fff"/></svg></a></div><div class=content><h1>A quick CORS proxy in a few lines of Clojure</h1><div class=meta><span class=yyydate>[2024-03-08 Fri]</span> on
<a href=https://her.esy.fun><span class=author>Yann Esposito</span>'s blog</a></div><div class=abstract></div></div></header><main id=content><article><p>When I open a new tab in my browser I see my hand-made starter
homepage. This is a single HTML file on my computer. Not a hosted
website. This homepage is really useful and along the years I added some
functionalities:<ul><li>organized links for my most frequently used websites<li>direct text input to some specialized search engines<li>work related links to a lot of different places, I see the APIs, the
version number of the deployed nodes, etc…<li>my daily work tasks are displayed there (from org-mode calendar to
this page)</ul><p>One of the section of links in this homepage contain a few website I
host. And I wanted to query these websites to make a health check from
my file. It turns out that you cannot easily make an HTTP call to any
external website from a <code class=verbatim>file://</code> in your
Browser as your are almost immediately blocked by <em>CORS</em>.<p>I don't want to explain how <em>CORS</em> are working. The important
point is that it is a security measure that is <strong>very
easy</strong> to circumvent.<p>Here is how to do it:<ol><li>Create a webservice that will play a role of "proxy". For example,
the webservice will read the <code>?url=DESTINATION_URL</code>.<li>When receiving a request, the server will make a similar HTTP call
to <code>DESTINATION_URL</code> and keep track of the
<code>Origin</code> HTTP header of the request.<li>Take the response from <code>DESTINATION_URL</code> and add a few
headers, in particular add the <code>Access-Control-Allow-Origin</code>
header that will contain the value in the <code>Origin</code> header of
the request.</ol><p>That's it.<p>So I wrote that in few minutes and use it now. So I can make these
call and detect when I see my homepage if one of my hosted website is
not reachable.<h1 id=the-clojure-code>The Clojure code</h1><p>Here is the code in a few lines of Clojure:<div class=sourceCode id=cb1><pre class="sourceCode clojure"><code class="sourceCode clojure"><span id=cb1-1><a href=#cb1-1 aria-hidden=true tabindex=-1></a>(<span class=kw>ns</span> fuck-cors-app.core</span>
<span id=cb1-2><a href=#cb1-2 aria-hidden=true tabindex=-1></a>  (<span class=at>:require</span></span>
<span id=cb1-3><a href=#cb1-3 aria-hidden=true tabindex=-1></a>    [clj-http.client <span class=at>:as</span> client]</span>
<span id=cb1-4><a href=#cb1-4 aria-hidden=true tabindex=-1></a>    [ring.adapter.jetty <span class=at>:as</span> jetty]</span>
<span id=cb1-5><a href=#cb1-5 aria-hidden=true tabindex=-1></a>    [ring.middleware.params <span class=at>:refer</span> [wrap-params]]</span>
<span id=cb1-6><a href=#cb1-6 aria-hidden=true tabindex=-1></a>    [fuck-cors.core <span class=at>:refer</span> [wrap-open-cors]])</span>
<span id=cb1-7><a href=#cb1-7 aria-hidden=true tabindex=-1></a>  (<span class=at>:gen-class</span>))</span>
<span id=cb1-8><a href=#cb1-8 aria-hidden=true tabindex=-1></a></span>
<span id=cb1-9><a href=#cb1-9 aria-hidden=true tabindex=-1></a>(<span class=bu>defn</span><span class=fu> handler</span></span>
<span id=cb1-10><a href=#cb1-10 aria-hidden=true tabindex=-1></a>  [request]</span>
<span id=cb1-11><a href=#cb1-11 aria-hidden=true tabindex=-1></a>  (<span class=kw>if-let</span> [url (<span class=kw>get-in</span> request [<span class=at>:query-params</span> <span class=st>&quot;url&quot;</span>])]</span>
<span id=cb1-12><a href=#cb1-12 aria-hidden=true tabindex=-1></a>    (client/request {<span class=at>:request-method</span> (<span class=at>:request-method</span> request)</span>
<span id=cb1-13><a href=#cb1-13 aria-hidden=true tabindex=-1></a>                     <span class=at>:url</span> url})</span>
<span id=cb1-14><a href=#cb1-14 aria-hidden=true tabindex=-1></a>    {<span class=at>:status</span> <span class=dv>200</span></span>
<span id=cb1-15><a href=#cb1-15 aria-hidden=true tabindex=-1></a>     <span class=at>:headers</span> {<span class=st>&quot;Content-Type&quot;</span> <span class=st>&quot;text/plain; charset=utf-8&quot;</span>}</span>
<span id=cb1-16><a href=#cb1-16 aria-hidden=true tabindex=-1></a>     <span class=at>:body</span> <span class=st>&quot;Let&#39;s bypass CORS ok?&quot;</span>}))</span>
<span id=cb1-17><a href=#cb1-17 aria-hidden=true tabindex=-1></a></span>
<span id=cb1-18><a href=#cb1-18 aria-hidden=true tabindex=-1></a>(<span class=bu>defn</span><span class=fu> -main</span></span>
<span id=cb1-19><a href=#cb1-19 aria-hidden=true tabindex=-1></a>  [&amp; _args]</span>
<span id=cb1-20><a href=#cb1-20 aria-hidden=true tabindex=-1></a>  (jetty/run-jetty</span>
<span id=cb1-21><a href=#cb1-21 aria-hidden=true tabindex=-1></a>    (<span class=kw>-&gt;</span> handler</span>
<span id=cb1-22><a href=#cb1-22 aria-hidden=true tabindex=-1></a>        (wrap-params)</span>
<span id=cb1-23><a href=#cb1-23 aria-hidden=true tabindex=-1></a>        (wrap-open-cors))</span>
<span id=cb1-24><a href=#cb1-24 aria-hidden=true tabindex=-1></a>    {<span class=at>:port</span> <span class=dv>1977</span></span>
<span id=cb1-25><a href=#cb1-25 aria-hidden=true tabindex=-1></a>     <span class=at>:host</span> <span class=st>&quot;127.0.0.1&quot;</span>}))</span></code></pre></div><p>And that's it, this is a whole web application that will proxy any
call to a website that do not allow you to call from some origin (like
my <code class=verbatim>file://</code>) and will make it work
anyway.<p>If you feel that using too many libraries is cheating, here is the
actual almost full content of the lib taking care of handling CORS:<div class=sourceCode id=cb2><pre class="sourceCode clojure"><code class="sourceCode clojure"><span id=cb2-1><a href=#cb2-1 aria-hidden=true tabindex=-1></a>(<span class=bu>defn-</span><span class=fu> host-from-req</span></span>
<span id=cb2-2><a href=#cb2-2 aria-hidden=true tabindex=-1></a>  [request]</span>
<span id=cb2-3><a href=#cb2-3 aria-hidden=true tabindex=-1></a>  (<span class=kw>str</span> (<span class=kw>-&gt;</span> request <span class=at>:scheme</span> <span class=kw>name</span>)</span>
<span id=cb2-4><a href=#cb2-4 aria-hidden=true tabindex=-1></a>       <span class=st>&quot;://&quot;</span></span>
<span id=cb2-5><a href=#cb2-5 aria-hidden=true tabindex=-1></a>       (<span class=kw>get-in</span> request [<span class=at>:headers</span> <span class=st>&quot;host&quot;</span>])))</span>
<span id=cb2-6><a href=#cb2-6 aria-hidden=true tabindex=-1></a></span>
<span id=cb2-7><a href=#cb2-7 aria-hidden=true tabindex=-1></a>(<span class=bu>defn-</span><span class=fu> get-header</span></span>
<span id=cb2-8><a href=#cb2-8 aria-hidden=true tabindex=-1></a>  [request header-name]</span>
<span id=cb2-9><a href=#cb2-9 aria-hidden=true tabindex=-1></a>  (<span class=kw>let</span> [rawref (<span class=kw>get-in</span> request [<span class=at>:headers</span> header-name])]</span>
<span id=cb2-10><a href=#cb2-10 aria-hidden=true tabindex=-1></a>    (<span class=kw>if</span> rawref</span>
<span id=cb2-11><a href=#cb2-11 aria-hidden=true tabindex=-1></a>        (clojure.string/replace rawref <span class=ss>#&quot;(http://[^/]*).*$&quot;</span> <span class=st>&quot;$1&quot;</span>)</span>
<span id=cb2-12><a href=#cb2-12 aria-hidden=true tabindex=-1></a>        <span class=va>nil</span>)))</span>
<span id=cb2-13><a href=#cb2-13 aria-hidden=true tabindex=-1></a></span>
<span id=cb2-14><a href=#cb2-14 aria-hidden=true tabindex=-1></a>(<span class=bu>defn</span><span class=fu> wrap-open-cors</span></span>
<span id=cb2-15><a href=#cb2-15 aria-hidden=true tabindex=-1></a>  <span class=st>&quot;Open your Origin Policy to Everybody, no limit&quot;</span></span>
<span id=cb2-16><a href=#cb2-16 aria-hidden=true tabindex=-1></a>  [handler]</span>
<span id=cb2-17><a href=#cb2-17 aria-hidden=true tabindex=-1></a>  (<span class=kw>fn</span> [request]</span>
<span id=cb2-18><a href=#cb2-18 aria-hidden=true tabindex=-1></a>    (<span class=kw>let</span> [origin (get-header request <span class=st>&quot;origin&quot;</span>)</span>
<span id=cb2-19><a href=#cb2-19 aria-hidden=true tabindex=-1></a>          referer (get-header request <span class=st>&quot;referer&quot;</span>)</span>
<span id=cb2-20><a href=#cb2-20 aria-hidden=true tabindex=-1></a>          host (host-from-req request)</span>
<span id=cb2-21><a href=#cb2-21 aria-hidden=true tabindex=-1></a>          origins (<span class=kw>if</span> origin</span>
<span id=cb2-22><a href=#cb2-22 aria-hidden=true tabindex=-1></a>                    origin</span>
<span id=cb2-23><a href=#cb2-23 aria-hidden=true tabindex=-1></a>                    (<span class=kw>if</span> referer</span>
<span id=cb2-24><a href=#cb2-24 aria-hidden=true tabindex=-1></a>                      referer</span>
<span id=cb2-25><a href=#cb2-25 aria-hidden=true tabindex=-1></a>                      host))</span>
<span id=cb2-26><a href=#cb2-26 aria-hidden=true tabindex=-1></a>          headers {<span class=st>&quot;Access-Control-Allow-Origin&quot;</span> origins</span>
<span id=cb2-27><a href=#cb2-27 aria-hidden=true tabindex=-1></a>                   <span class=st>&quot;Access-Control-Allow-Headers&quot;</span> <span class=st>&quot;Origin, X-Requested-With, Content-Type, Accept, Cache-Control, Accept-Language, Accept-Encoding, Authorization&quot;</span></span>
<span id=cb2-28><a href=#cb2-28 aria-hidden=true tabindex=-1></a>                   <span class=st>&quot;Access-Control-Allow-Methods&quot;</span> <span class=st>&quot;HEAD, GET, POST, PUT, DELETE, OPTIONS, TRACE&quot;</span></span>
<span id=cb2-29><a href=#cb2-29 aria-hidden=true tabindex=-1></a>                   <span class=st>&quot;Access-Control-Allow-Credentials&quot;</span> <span class=st>&quot;true&quot;</span></span>
<span id=cb2-30><a href=#cb2-30 aria-hidden=true tabindex=-1></a>                   <span class=st>&quot;Access-Control-Expose-Headers&quot;</span> <span class=st>&quot;content-length&quot;</span></span>
<span id=cb2-31><a href=#cb2-31 aria-hidden=true tabindex=-1></a>                   <span class=st>&quot;Vary&quot;</span> <span class=st>&quot;Accept-Encoding, Origin, Accept-Language&quot;</span>}]</span>
<span id=cb2-32><a href=#cb2-32 aria-hidden=true tabindex=-1></a>      (<span class=kw>-&gt;</span> (handler request)</span>
<span id=cb2-33><a href=#cb2-33 aria-hidden=true tabindex=-1></a>          (<span class=kw>update-in</span> [<span class=at>:headers</span>] #(<span class=kw>into</span> <span class=va>%</span> headers))))))</span>
<span id=cb2-34><a href=#cb2-34 aria-hidden=true tabindex=-1></a></span>
<span id=cb2-35><a href=#cb2-35 aria-hidden=true tabindex=-1></a>(<span class=bu>defn</span><span class=fu> wrap-preflight</span></span>
<span id=cb2-36><a href=#cb2-36 aria-hidden=true tabindex=-1></a>  <span class=st>&quot;Add a preflight answer. Will break any OPTIONS handler, beware.</span></span>
<span id=cb2-37><a href=#cb2-37 aria-hidden=true tabindex=-1></a><span class=st>  To put AFTER wrap-open-cors&quot;</span></span>
<span id=cb2-38><a href=#cb2-38 aria-hidden=true tabindex=-1></a>  [handler]</span>
<span id=cb2-39><a href=#cb2-39 aria-hidden=true tabindex=-1></a>  (<span class=kw>fn</span> [request]</span>
<span id=cb2-40><a href=#cb2-40 aria-hidden=true tabindex=-1></a>    (<span class=kw>if</span> (<span class=kw>=</span> (request <span class=at>:request-method</span>) <span class=at>:options</span>)</span>
<span id=cb2-41><a href=#cb2-41 aria-hidden=true tabindex=-1></a>      (<span class=kw>into</span> request {<span class=at>:status</span> <span class=dv>200</span> <span class=at>:body</span> <span class=st>&quot;preflight complete&quot;</span>})</span>
<span id=cb2-42><a href=#cb2-42 aria-hidden=true tabindex=-1></a>      (handler request))))</span></code></pre></div><p>I wrote it a long time ago, and I think I just found a potential bug
related to the headers. I should probably retrieve all headers returned
by the response, and add these header name to the
<code>Access-Control-Allow-Headers</code>. But this list of allowed
headers will work most of the time.<h1 id=bonus-frontend-code-to-check-the-availability-of-a-website>Bonus
frontend code to check the availability of a website</h1><p>As a bonus here is the code I use in my homepage to see if the
website I am looking for are reachable or not.<p>Imagine you have an HTML block like this:<div class=sourceCode id=cb3><pre class="sourceCode html"><code class="sourceCode html"><span id=cb3-1><a href=#cb3-1 aria-hidden=true tabindex=-1></a><span class=kw>&lt;div</span> <span class=er>class</span><span class=ot>=</span><span class=st>&quot;healthcheck&quot;</span><span class=kw>&gt;</span></span>
<span id=cb3-2><a href=#cb3-2 aria-hidden=true tabindex=-1></a>  ...</span>
<span id=cb3-3><a href=#cb3-3 aria-hidden=true tabindex=-1></a>  <span class=kw>&lt;a</span> <span class=er>href</span><span class=ot>=</span><span class=st>&quot;SOME_URL&quot;</span><span class=kw>&gt;</span>website 1<span class=kw>&lt;/a&gt;</span></span>
<span id=cb3-4><a href=#cb3-4 aria-hidden=true tabindex=-1></a>  ...</span>
<span id=cb3-5><a href=#cb3-5 aria-hidden=true tabindex=-1></a>  <span class=kw>&lt;a</span> <span class=er>href</span><span class=ot>=</span><span class=st>&quot;SOME_URL&quot;</span><span class=kw>&gt;</span>website 2<span class=kw>&lt;/a&gt;</span></span>
<span id=cb3-6><a href=#cb3-6 aria-hidden=true tabindex=-1></a>  ...</span>
<span id=cb3-7><a href=#cb3-7 aria-hidden=true tabindex=-1></a><span class=kw>&lt;/div&gt;</span></span></code></pre></div><p>I have a CSS rule that change the background of these link to green
or red if I add the class <code>ok</code> or <code>error</code> to the
<code>&lt;a></code>. And here is the javascript code:<div class=sourceCode id=cb4><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id=cb4-1><a href=#cb4-1 aria-hidden=true tabindex=-1></a><span class=co>// You can replace corsproxy.org (which is a public one)</span></span>
<span id=cb4-2><a href=#cb4-2 aria-hidden=true tabindex=-1></a><span class=co>// by the one you are hoting.</span></span>
<span id=cb4-3><a href=#cb4-3 aria-hidden=true tabindex=-1></a><span class=kw>const</span> corsproxyurl<span class=op>=</span><span class=st>&#39;https://corsproxy.org/?&#39;</span><span class=op>;</span></span>
<span id=cb4-4><a href=#cb4-4 aria-hidden=true tabindex=-1></a><span class=kw>async</span> <span class=kw>function</span> <span class=fu>healthchecklink</span>(a) {</span>
<span id=cb4-5><a href=#cb4-5 aria-hidden=true tabindex=-1></a>  <span class=kw>var</span> linkurl<span class=op>=</span>a<span class=op>.</span><span class=at>href</span><span class=op>;</span></span>
<span id=cb4-6><a href=#cb4-6 aria-hidden=true tabindex=-1></a>  <span class=cf>if</span> (linkurl <span class=op>!=</span> <span class=kw>undefined</span>) {</span>
<span id=cb4-7><a href=#cb4-7 aria-hidden=true tabindex=-1></a>    <span class=kw>var</span> url <span class=op>=</span> corsproxyurl <span class=op>+</span> <span class=pp>encodeURIComponent</span>(linkurl)<span class=op>;</span></span>
<span id=cb4-8><a href=#cb4-8 aria-hidden=true tabindex=-1></a>    <span class=cf>try</span> {</span>
<span id=cb4-9><a href=#cb4-9 aria-hidden=true tabindex=-1></a>      <span class=kw>var</span> response <span class=op>=</span> <span class=cf>await</span> <span class=fu>fetch</span>(url<span class=op>,</span> {<span class=dt>method</span><span class=op>:</span> <span class=st>&#39;GET&#39;</span><span class=op>,</span></span>
<span id=cb4-10><a href=#cb4-10 aria-hidden=true tabindex=-1></a>                                       <span class=dt>redirect</span><span class=op>:</span> <span class=st>&#39;manual&#39;</span><span class=op>,</span></span>
<span id=cb4-11><a href=#cb4-11 aria-hidden=true tabindex=-1></a>                                       <span class=dt>signal</span><span class=op>:</span> AbortSignal<span class=op>.</span><span class=fu>timeout</span>(<span class=dv>3000</span>)</span>
<span id=cb4-12><a href=#cb4-12 aria-hidden=true tabindex=-1></a>                                      })<span class=op>;</span></span>
<span id=cb4-13><a href=#cb4-13 aria-hidden=true tabindex=-1></a>      <span class=cf>if</span> (response<span class=op>.</span><span class=at>ok</span> <span class=op>||</span> response<span class=op>.</span><span class=at>redirected</span> <span class=op>||</span> response<span class=op>.</span><span class=at>status</span> <span class=op>===</span> <span class=dv>0</span> ) {</span>
<span id=cb4-14><a href=#cb4-14 aria-hidden=true tabindex=-1></a>        a<span class=op>.</span><span class=at>classList</span><span class=op>.</span><span class=fu>add</span>(<span class=st>&quot;ok&quot;</span>)<span class=op>;</span></span>
<span id=cb4-15><a href=#cb4-15 aria-hidden=true tabindex=-1></a>      } <span class=cf>else</span> {</span>
<span id=cb4-16><a href=#cb4-16 aria-hidden=true tabindex=-1></a>        a<span class=op>.</span><span class=at>classList</span><span class=op>.</span><span class=fu>add</span>(<span class=st>&quot;error&quot;</span>)<span class=op>;</span></span>
<span id=cb4-17><a href=#cb4-17 aria-hidden=true tabindex=-1></a>      }</span>
<span id=cb4-18><a href=#cb4-18 aria-hidden=true tabindex=-1></a>    } <span class=cf>catch</span> (err) {</span>
<span id=cb4-19><a href=#cb4-19 aria-hidden=true tabindex=-1></a>      a<span class=op>.</span><span class=at>classList</span><span class=op>.</span><span class=fu>add</span>(<span class=st>&quot;error&quot;</span>)<span class=op>;</span></span>
<span id=cb4-20><a href=#cb4-20 aria-hidden=true tabindex=-1></a>    }</span>
<span id=cb4-21><a href=#cb4-21 aria-hidden=true tabindex=-1></a>  }</span>
<span id=cb4-22><a href=#cb4-22 aria-hidden=true tabindex=-1></a>}</span>
<span id=cb4-23><a href=#cb4-23 aria-hidden=true tabindex=-1></a></span>
<span id=cb4-24><a href=#cb4-24 aria-hidden=true tabindex=-1></a><span class=kw>function</span> <span class=fu>checkhealth</span>() {</span>
<span id=cb4-25><a href=#cb4-25 aria-hidden=true tabindex=-1></a>  <span class=kw>var</span> links <span class=op>=</span> <span class=bu>document</span><span class=op>.</span><span class=fu>querySelectorAll</span>(<span class=st>&#39;.healthcheck a&#39;</span>)<span class=op>;</span></span>
<span id=cb4-26><a href=#cb4-26 aria-hidden=true tabindex=-1></a>  <span class=cf>for</span> (l <span class=kw>in</span> links) {</span>
<span id=cb4-27><a href=#cb4-27 aria-hidden=true tabindex=-1></a>    <span class=fu>healthchecklink</span>(links[l])<span class=op>;</span></span>
<span id=cb4-28><a href=#cb4-28 aria-hidden=true tabindex=-1></a>  }</span>
<span id=cb4-29><a href=#cb4-29 aria-hidden=true tabindex=-1></a>}</span>
<span id=cb4-30><a href=#cb4-30 aria-hidden=true tabindex=-1></a></span>
<span id=cb4-31><a href=#cb4-31 aria-hidden=true tabindex=-1></a><span class=fu>checkhealth</span>()<span class=op>;</span></span></code></pre></div><p>Notice the <code>response.status == 0</code>, this is due to one of
my website returning a 303 redirection but some complication make it
returns a status 0. If there were an error it would return an error
status.<p>That's it. Another tool I created myself to prevent me using a
service checking for the status of my website and sending me
notifications about it. None of my website is crucial enough not be ok
to wait a few hours to be re-enabled.</article></main><footer id=postamble class=status><div class=content><nav role=navigation><a href=/index.html>Home</a> |
<a href=/slides.html>Slides</a> |
<a href=/about-me.html>About</a>
<span class=details>(<a href=https://gitea.esy.fun/yogsototh>code</a>
<a href=https://espial.esy.fun/u:yogsototh>bookmarks</a>
<a href=https://espial.esy.fun/u:yogsototh/notes>notes</a>)</span> |
<a href=#logo>↑ Top ↑</a></nav></div></footer>