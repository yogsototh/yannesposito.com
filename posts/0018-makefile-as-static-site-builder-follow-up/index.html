<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Fast Static Site with make</title><meta name=author content="Yann Esposito"><meta name=description content="A deeper view of my static site
builder Makefile"><meta name=keywords content="blog static"><link rel=stylesheet href=/css/y.css><link rel=alternate type=application/rss+xml href=/rss.xml><link rel=icon href=/favicon.ico><meta name=theme-color media="(prefers-color-scheme: light)" content="#d84100"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#2E3440"><header><div id=logo><a href=/><div class=vis-hidden>Go to Home</div><svg width="5em" viewBox="0 0 64 64"><circle cx="32" cy="32" r="30" stroke="#00" stroke-width="1" fill="#2e3440"/><circle class="i1" cx="32" cy="32" r="12" stroke="#800" stroke-width="1" fill="#c20"/><circle class="i0" cx="32" cy="32" r="5" stroke-width="1" stroke="#f60" fill="#fa0"/><ellipse class="e" cx="32" cy="14" rx="14" ry="8" stroke-width="0" fill="#fff"/></svg></a></div><div class=content><h1>Fast Static Site with make</h1><div class=meta><span class=yyydate>[2021-05-25 Tue]</span> on
<a href=https://her.esy.fun><span class=author>Yann Esposito</span>'s blog</a></div><div class=abstract>A deeper view of my static site builder Makefile</div></div></header><main id=content><article><p>This article will dig a bit deeper about my <code class=verbatim>Makefile</code> based static website generator. In a <a href=https://her.esy.fun/posts/0017-static-blog-builder/index.html>previous
article</a> I just gave the rationale and an overview to do it yourself.
Mainly it is very fast and portable.<p>A few goals reached by my current build system are:<ol><li>Be fast and make the minimal amount of work as possible. I don't
want to rebuild all the html pages if I only change one file.<li>Source file format agnostic. You can use markdown, org-mode or even
directly write html.<li>Support gemini<li>Optimize size: minify HTML, CSS, images<li>Generate an index page listing the posts<li>Generate RSS/atom feed (for both gemini and http)</ol><p><code class=verbatim>make</code> will take care of handling the
dependency graph to minimize the amount of effort when a change occurs
in the sources. For some features, I built specifics small shell
scripts. For example to be absolutely agnostic in the source format for
my articles I generate the RSS out of a tree of HTML files. But taking
advantage of <code class=verbatim>make</code>, I generate an index
cache to transform those HTML into XML which will be faster to use to
build different indexes. To make those transformations I use very short
a shell scripts.<h1 id=-makefile--overview><code class=verbatim>Makefile</code>
overview</h1><p>A Makefile is made out of rules. The first rule of your Makefile will
be the default rule. The first rule of my Makefile is called <code class=verbatim>all</code>.<p>A rule as the following format:<div class=sourceCode id=cb1><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id=cb1-1><a href=#cb1-1 aria-hidden=true tabindex=-1></a><span class=dv>target:</span><span class=dt> file1 file2</span></span>
<span id=cb1-2><a href=#cb1-2 aria-hidden=true tabindex=-1></a>    cmd --input file1 file2 <span class=ch>\</span></span>
<span id=cb1-3><a href=#cb1-3 aria-hidden=true tabindex=-1></a>        --output target</span></code></pre></div><p>if <code class=verbatim>target</code> does not exists, then <code class=verbatim>make</code> will look at its dependencies. If any of
its dependencies need to be updated, it will run all the rules in the
correct order to rebuild them and finally run the script to build <code class=verbatim>target</code>. A file needs to be updated if one of its
dependency needs to be updated or is newer.<p>The usual use case of <code class=verbatim>make</code> is about
building a single binary out of many source files. But for a static
website, we need to generate a lot of files from a lot of files. So we
construct the rules like this:<div class=sourceCode id=cb2><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id=cb2-1><a href=#cb2-1 aria-hidden=true tabindex=-1></a><span class=dv>all:</span><span class=dt> site</span></span>
<span id=cb2-2><a href=#cb2-2 aria-hidden=true tabindex=-1></a></span>
<span id=cb2-3><a href=#cb2-3 aria-hidden=true tabindex=-1></a><span class=co># build a list of files that will need to be build</span></span>
<span id=cb2-4><a href=#cb2-4 aria-hidden=true tabindex=-1></a><span class=dt>DST_FILES </span><span class=ch>:=</span><span class=st> ....</span></span>
<span id=cb2-5><a href=#cb2-5 aria-hidden=true tabindex=-1></a><span class=co># RULES TO GENERATE DST_FILES</span></span>
<span id=cb2-6><a href=#cb2-6 aria-hidden=true tabindex=-1></a><span class=dt>ALL </span><span class=ch>+=</span><span class=st> </span><span class=ch>$(</span><span class=dt>DST_FILES</span><span class=ch>)</span></span>
<span id=cb2-7><a href=#cb2-7 aria-hidden=true tabindex=-1></a></span>
<span id=cb2-8><a href=#cb2-8 aria-hidden=true tabindex=-1></a><span class=co># another list of files</span></span>
<span id=cb2-9><a href=#cb2-9 aria-hidden=true tabindex=-1></a><span class=dt>DST_FILES_2 </span><span class=ch>:=</span><span class=st> ....</span></span>
<span id=cb2-10><a href=#cb2-10 aria-hidden=true tabindex=-1></a><span class=co># RULES TO GENERATE DST_FILES_2</span></span>
<span id=cb2-11><a href=#cb2-11 aria-hidden=true tabindex=-1></a><span class=dt>ALL </span><span class=ch>+=</span><span class=st> </span><span class=ch>$(</span><span class=dt>DST_FILES_2</span><span class=ch>)</span></span>
<span id=cb2-12><a href=#cb2-12 aria-hidden=true tabindex=-1></a></span>
<span id=cb2-13><a href=#cb2-13 aria-hidden=true tabindex=-1></a><span class=dv>site:</span><span class=dt> </span><span class=ch>$(</span><span class=dt>ALL</span><span class=ch>)</span></span></code></pre></div><p>In my <code class=verbatim>Makefile</code> I have many similar
block with the same pattern.<ol><li>I retrieve a list of source files<li>I construct the list of destination files (change the directory, the
extension)<li>I declare a rule to construct these destination files<li>I add the destination files to the <code class=verbatim>ALL</code>
variable.</ol><p>I have a block for:<ul><li>raw assets I just want copied<li>images I would like to compress for the web<li><code class=verbatim>html</code> I would like to generate from org
mode files via pandoc<li><code class=verbatim>gmi</code> I would like to generate from org
mode files<li><code class=verbatim>xml</code> files I use as cache to build
different index files<li><code class=verbatim>index.html</code> file containing a list of
my posts<li><code class=verbatim>rss.xml</code> file containing a list of my
posts<li><code class=verbatim>gemini-atom.xml</code> file containing a list
of my posts</ul><h2 id=assets>Assets</h2><p>The rules to copy assets will be a good first example.<ol><li>find all assets in <code class=verbatim>src/</code> directory<li>generate all assets from these files in <code class=verbatim>_site/</code> directory<li>make this rule a dependency on the <code class=verbatim>all</code>
rule.</ol><div class=sourceCode id=cb3><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id=cb3-1><a href=#cb3-1 aria-hidden=true tabindex=-1></a><span class=dt>SRC_ASSETS </span><span class=ch>:=</span><span class=st> </span><span class=ch>$(</span><span class=kw>shell</span><span class=st> find src -type f</span><span class=ch>)</span></span>
<span id=cb3-2><a href=#cb3-2 aria-hidden=true tabindex=-1></a><span class=dt>DST_ASSETS </span><span class=ch>:=</span><span class=st> </span><span class=ch>$(</span><span class=kw>patsubst</span><span class=st> src/%</span><span class=kw>,</span><span class=st>_site/%</span><span class=kw>,</span><span class=ch>$(</span><span class=dt>SRC_ASSETS</span><span class=ch>))</span></span>
<span id=cb3-3><a href=#cb3-3 aria-hidden=true tabindex=-1></a><span class=dv>_site/% :</span><span class=dt> src/%</span></span>
<span id=cb3-4><a href=#cb3-4 aria-hidden=true tabindex=-1></a>    <span class=ch>@</span><span class=fu>mkdir -p </span><span class=st>&quot;</span><span class=ch>$(</span><span class=kw>dir</span><span class=st> </span><span class=ch>$@)</span><span class=st>&quot;</span></span>
<span id=cb3-5><a href=#cb3-5 aria-hidden=true tabindex=-1></a>    cp <span class=st>&quot;</span><span class=ch>$&lt;</span><span class=st>&quot;</span> <span class=st>&quot;</span><span class=ch>$@</span><span class=st>&quot;</span></span>
<span id=cb3-6><a href=#cb3-6 aria-hidden=true tabindex=-1></a><span class=ot>.PHONY:</span><span class=dt> assets</span></span>
<span id=cb3-7><a href=#cb3-7 aria-hidden=true tabindex=-1></a><span class=dv>assets:</span><span class=dt> </span><span class=ch>$(</span><span class=dt>DST_ASSETS</span><span class=ch>)</span></span>
<span id=cb3-8><a href=#cb3-8 aria-hidden=true tabindex=-1></a><span class=dt>ALL </span><span class=ch>+=</span><span class=st> assets</span></span></code></pre></div><p>OK, this looks terrible. But mainly:<ul><li><code>SRC_ASSETS</code> will contain the result of the command
<code>find</code>.<li><code>DST_ASSETS</code> will contain the files of
<code>SRC_ASSETS</code> but we replace the <code class=verbatim>src/</code> by <code class=verbatim>_site/</code>.<li>We create a generic rule; for all files matching the following
pattern <code class=verbatim>_site/%</code>, look for the file <code class=verbatim>src/%</code> and if it is newer (in our case) then
execute the following commands:<ul><li>create the directory to put <code class=verbatim>_site/%</code>
in<li>copy the file</ul></ul><p>About the line <code>@mkdir -p "$(dir $@)"</code>:<ul><li>the <code class=verbatim>@</code> at the start of the command
simply means that we make this execution silent.<li>The <code class=verbatim>$@</code> is replaced by the target
string.<li>And <code class=verbatim>$(dir $@)</code> will generate the folder
name of <code class=verbatim>$@</code>.</ul><p>For the line with <code>cp</code>, you just need to know that <code class=verbatim>~$&lt;~</code> will represent the first dependency.<p>My Makefile is composed of similar blocks, where I replace the first
find command to match specific files and where I use different building
rules. An important point is that the rules must be the most specific
possible. This is because <code class=verbatim>make</code> will use
the most specific rule in case of ambiguity. For example, the matching
rule <code class=verbatim>_site/%: src/%</code> will match all files
in the <code class=verbatim>src/</code> dir. But if we want to treat
<code class=verbatim>CSS</code> files with another rule we could
write:<div class=sourceCode id=cb4><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id=cb4-1><a href=#cb4-1 aria-hidden=true tabindex=-1></a><span class=dv>_site/%.css:</span><span class=dt> src/%.css</span></span>
<span id=cb4-2><a href=#cb4-2 aria-hidden=true tabindex=-1></a>    minify <span class=st>&quot;</span><span class=ch>$&lt;</span><span class=st>&quot;</span> <span class=st>&quot;</span><span class=ch>$@</span><span class=st>&quot;</span></span></code></pre></div><p>And if the selected file is a <code class=verbatim>CSS</code> file,
this rule will be selected.<h2 id=prelude>Prelude</h2><p>I start with variables declarations:<div class=sourceCode id=cb5><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id=cb5-1><a href=#cb5-1 aria-hidden=true tabindex=-1></a><span class=dv>all:</span><span class=dt> site</span></span>
<span id=cb5-2><a href=#cb5-2 aria-hidden=true tabindex=-1></a><span class=co># directory containing the source files</span></span>
<span id=cb5-3><a href=#cb5-3 aria-hidden=true tabindex=-1></a><span class=dt>SRC_DIR </span><span class=ch>?=</span><span class=st> src</span></span>
<span id=cb5-4><a href=#cb5-4 aria-hidden=true tabindex=-1></a><span class=co># directory that will contain the site files</span></span>
<span id=cb5-5><a href=#cb5-5 aria-hidden=true tabindex=-1></a><span class=dt>DST_DIR </span><span class=ch>?=</span><span class=st> _site</span></span>
<span id=cb5-6><a href=#cb5-6 aria-hidden=true tabindex=-1></a><span class=co># a directory that will contain a cache to speedup indexing</span></span>
<span id=cb5-7><a href=#cb5-7 aria-hidden=true tabindex=-1></a><span class=dt>CACHE_DIR </span><span class=ch>?=</span><span class=st> .cache</span></span>
<span id=cb5-8><a href=#cb5-8 aria-hidden=true tabindex=-1></a></span>
<span id=cb5-9><a href=#cb5-9 aria-hidden=true tabindex=-1></a><span class=co># options to pass to find to prevent matching files in the src/drafts</span></span>
<span id=cb5-10><a href=#cb5-10 aria-hidden=true tabindex=-1></a><span class=co># directory</span></span>
<span id=cb5-11><a href=#cb5-11 aria-hidden=true tabindex=-1></a><span class=dt>NO_DRAFT </span><span class=ch>:=</span><span class=st> -not -path &#39;</span><span class=ch>$(</span><span class=dt>SRC_DIR</span><span class=ch>)</span><span class=st>/drafts/*&#39;</span></span>
<span id=cb5-12><a href=#cb5-12 aria-hidden=true tabindex=-1></a><span class=co># option to pass to find to not match  org files</span></span>
<span id=cb5-13><a href=#cb5-13 aria-hidden=true tabindex=-1></a><span class=dt>NO_SRC_FILE </span><span class=ch>:=</span><span class=st> ! -name &#39;*.org&#39;</span></span></code></pre></div><h2 id=css>CSS</h2><p>Here we go; the same simple pattern for CSS files.<div class=sourceCode id=cb6><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id=cb6-1><a href=#cb6-1 aria-hidden=true tabindex=-1></a><span class=co># CSS</span></span>
<span id=cb6-2><a href=#cb6-2 aria-hidden=true tabindex=-1></a><span class=dt>SRC_CSS_FILES </span><span class=ch>:=</span><span class=st> </span><span class=ch>$(</span><span class=kw>shell</span><span class=st> find </span><span class=ch>$(</span><span class=dt>SRC_DIR</span><span class=ch>)</span><span class=st> -type f -name &#39;*.css&#39;</span><span class=ch>)</span></span>
<span id=cb6-3><a href=#cb6-3 aria-hidden=true tabindex=-1></a><span class=dt>DST_CSS_FILES </span><span class=ch>:=</span><span class=st> </span><span class=ch>$(</span><span class=kw>patsubst</span><span class=st> </span><span class=ch>$(</span><span class=dt>SRC_DIR</span><span class=ch>)</span><span class=st>/%</span><span class=kw>,</span><span class=ch>$(</span><span class=dt>DST_DIR</span><span class=ch>)</span><span class=st>/%</span><span class=kw>,</span><span class=ch>$(</span><span class=dt>SRC_RAW_FILES</span><span class=ch>))</span></span>
<span id=cb6-4><a href=#cb6-4 aria-hidden=true tabindex=-1></a><span class=dv>$(DST_DIR)/%.css :</span><span class=dt> </span><span class=ch>$(</span><span class=dt>SRC_DIR</span><span class=ch>)</span><span class=dt>/%.css</span></span>
<span id=cb6-5><a href=#cb6-5 aria-hidden=true tabindex=-1></a>    <span class=ch>@</span><span class=fu>mkdir -p </span><span class=st>&quot;</span><span class=ch>$(</span><span class=kw>dir</span><span class=st> </span><span class=ch>$@)</span><span class=st>&quot;</span></span>
<span id=cb6-6><a href=#cb6-6 aria-hidden=true tabindex=-1></a>    minify <span class=st>&quot;</span><span class=ch>$&lt;</span><span class=st>&quot;</span> &gt; <span class=st>&quot;</span><span class=ch>$@</span><span class=st>&quot;</span></span>
<span id=cb6-7><a href=#cb6-7 aria-hidden=true tabindex=-1></a><span class=ot>.PHONY:</span><span class=dt> css</span></span>
<span id=cb6-8><a href=#cb6-8 aria-hidden=true tabindex=-1></a><span class=dv>css:</span><span class=dt> </span><span class=ch>$(</span><span class=dt>DST_CSS_FILES</span><span class=ch>)</span></span>
<span id=cb6-9><a href=#cb6-9 aria-hidden=true tabindex=-1></a><span class=dt>ALL </span><span class=ch>+=</span><span class=st> css</span></span></code></pre></div><p>This is very similar to the block for raw assets. The difference is
just that instead of using <code class=verbatim>cp</code> we use the
<code class=verbatim>minify</code> command.<h2 id=org----html>ORG → HTML</h2><p>Now this one is more complex but is still follow the same
pattern.<div class=sourceCode id=cb7><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id=cb7-1><a href=#cb7-1 aria-hidden=true tabindex=-1></a><span class=co># ORG -&gt; HTML</span></span>
<span id=cb7-2><a href=#cb7-2 aria-hidden=true tabindex=-1></a><span class=dt>EXT </span><span class=ch>?=</span><span class=st> .org</span></span>
<span id=cb7-3><a href=#cb7-3 aria-hidden=true tabindex=-1></a><span class=dt>SRC_PANDOC_FILES </span><span class=ch>?=</span><span class=st> </span><span class=ch>$(</span><span class=kw>shell</span><span class=st> find </span><span class=ch>$(</span><span class=dt>SRC_DIR</span><span class=ch>)</span><span class=st> -type f -name &quot;*</span><span class=ch>$(</span><span class=dt>EXT</span><span class=ch>)</span><span class=st>&quot; </span><span class=ch>$(</span><span class=dt>NO_DRAFT</span><span class=ch>))</span></span>
<span id=cb7-4><a href=#cb7-4 aria-hidden=true tabindex=-1></a><span class=dt>DST_PANDOC_FILES </span><span class=ch>?=</span><span class=st> </span><span class=ch>$(</span><span class=kw>patsubst</span><span class=st> %</span><span class=ch>$(</span><span class=dt>EXT</span><span class=ch>)</span><span class=kw>,</span><span class=st>%.html</span><span class=kw>,</span><span class=st> \</span></span>
<span id=cb7-5><a href=#cb7-5 aria-hidden=true tabindex=-1></a><span class=st>                        </span><span class=ch>$(</span><span class=kw>patsubst</span><span class=st> </span><span class=ch>$(</span><span class=dt>SRC_DIR</span><span class=ch>)</span><span class=st>/%</span><span class=kw>,</span><span class=ch>$(</span><span class=dt>DST_DIR</span><span class=ch>)</span><span class=st>/%</span><span class=kw>,</span><span class=st> \</span></span>
<span id=cb7-6><a href=#cb7-6 aria-hidden=true tabindex=-1></a><span class=st>                            </span><span class=ch>$(</span><span class=dt>SRC_PANDOC_FILES</span><span class=ch>)))</span></span>
<span id=cb7-7><a href=#cb7-7 aria-hidden=true tabindex=-1></a><span class=dt>PANDOC_TEMPLATE </span><span class=ch>?=</span><span class=st> templates/post.html</span></span>
<span id=cb7-8><a href=#cb7-8 aria-hidden=true tabindex=-1></a><span class=dt>MK_HTML </span><span class=ch>:=</span><span class=st> engine/mk-html.sh</span></span>
<span id=cb7-9><a href=#cb7-9 aria-hidden=true tabindex=-1></a><span class=dt>PANDOC </span><span class=ch>:=</span><span class=st> </span><span class=ch>$(</span><span class=dt>MK_HTML</span><span class=ch>)</span><span class=st> </span><span class=ch>$(</span><span class=dt>PANDOC_TEMPLATE</span><span class=ch>)</span></span>
<span id=cb7-10><a href=#cb7-10 aria-hidden=true tabindex=-1></a><span class=dv>$(DST_DIR)/%.html:</span><span class=dt> </span><span class=ch>$(</span><span class=dt>SRC_DIR</span><span class=ch>)</span><span class=dt>/%.org </span><span class=ch>$(</span><span class=dt>PANDOC_TEMPLATE</span><span class=ch>)</span><span class=dt> </span><span class=ch>$(</span><span class=dt>MK_HTML</span><span class=ch>)</span></span>
<span id=cb7-11><a href=#cb7-11 aria-hidden=true tabindex=-1></a>    <span class=ch>@</span><span class=fu>mkdir -p </span><span class=st>&quot;</span><span class=ch>$(</span><span class=kw>dir</span><span class=st> </span><span class=ch>$@)</span><span class=st>&quot;</span></span>
<span id=cb7-12><a href=#cb7-12 aria-hidden=true tabindex=-1></a>    <span class=ch>$(</span><span class=dt>PANDOC</span><span class=ch>)</span> <span class=st>&quot;</span><span class=ch>$&lt;</span><span class=st>&quot;</span> <span class=st>&quot;</span><span class=ch>$@</span><span class=st>.tmp&quot;</span></span>
<span id=cb7-13><a href=#cb7-13 aria-hidden=true tabindex=-1></a>    minify --mime text/html <span class=st>&quot;</span><span class=ch>$@</span><span class=st>.tmp&quot;</span> &gt; <span class=st>&quot;</span><span class=ch>$@</span><span class=st>&quot;</span></span>
<span id=cb7-14><a href=#cb7-14 aria-hidden=true tabindex=-1></a>    <span class=ch>@</span><span class=fu>rm </span><span class=st>&quot;</span><span class=ch>$@</span><span class=st>.tmp&quot;</span></span>
<span id=cb7-15><a href=#cb7-15 aria-hidden=true tabindex=-1></a><span class=ot>.PHONY:</span><span class=dt> html</span></span>
<span id=cb7-16><a href=#cb7-16 aria-hidden=true tabindex=-1></a><span class=dv>html:</span><span class=dt> </span><span class=ch>$(</span><span class=dt>DST_PANDOC_FILES</span><span class=ch>)</span></span>
<span id=cb7-17><a href=#cb7-17 aria-hidden=true tabindex=-1></a><span class=dt>ALL </span><span class=ch>+=</span><span class=st> html</span></span></code></pre></div><p>So to construct <code class=verbatim>DST_PANDOC_FILES</code> this
time we also need to change the extension of the file from <code class=verbatim>org</code> to <code class=verbatim>html</code>. We
need to provide a template that will be passed to pandoc.<p>And of course, as if we change the template file we would like to
regenerate all HTML files we put the template as a dependency. But
importantly <strong>not</strong> at the first place. Because we use
<code class=verbatim>$&lt;</code> that will be the first
dependency.<p>I also have a short script instead of directly using <code class=verbatim>pandoc</code>. It is easier to handle <code class=verbatim>toc</code> using the metadatas in the file. And if
someday I want to put the template in the metas, this will be the right
place to put that.<p>The <code class=verbatim>mk-html.sh</code> is quite
straightforward:<div class=sourceCode id=cb8><pre class="sourceCode bash"><code class="sourceCode bash"><span id=cb8-1><a href=#cb8-1 aria-hidden=true tabindex=-1></a><span class=co>#!/usr/bin/env bash</span></span>
<span id=cb8-2><a href=#cb8-2 aria-hidden=true tabindex=-1></a><span class=bu>set</span> <span class=at>-eu</span></span>
<span id=cb8-3><a href=#cb8-3 aria-hidden=true tabindex=-1></a></span>
<span id=cb8-4><a href=#cb8-4 aria-hidden=true tabindex=-1></a><span class=co># put me at the top level of my project (like Makefile)</span></span>
<span id=cb8-5><a href=#cb8-5 aria-hidden=true tabindex=-1></a><span class=bu>cd</span> <span class=st>&quot;</span><span class=va>$(</span><span class=fu>git</span> rev-parse <span class=at>--show-toplevel</span><span class=va>)</span><span class=st>&quot;</span> <span class=kw>||</span> <span class=bu>exit</span> 1</span>
<span id=cb8-6><a href=#cb8-6 aria-hidden=true tabindex=-1></a><span class=va>template</span><span class=op>=</span><span class=st>&quot;</span><span class=va>$1</span><span class=st>&quot;</span></span>
<span id=cb8-7><a href=#cb8-7 aria-hidden=true tabindex=-1></a><span class=va>orgfile</span><span class=op>=</span><span class=st>&quot;</span><span class=va>$2</span><span class=st>&quot;</span></span>
<span id=cb8-8><a href=#cb8-8 aria-hidden=true tabindex=-1></a><span class=va>htmlfile</span><span class=op>=</span><span class=st>&quot;</span><span class=va>$3</span><span class=st>&quot;</span></span>
<span id=cb8-9><a href=#cb8-9 aria-hidden=true tabindex=-1></a></span>
<span id=cb8-10><a href=#cb8-10 aria-hidden=true tabindex=-1></a><span class=co># check if there is the #+OPTIONS: toc:t</span></span>
<span id=cb8-11><a href=#cb8-11 aria-hidden=true tabindex=-1></a><span class=va>tocoption</span><span class=op>=</span><span class=st>&quot;&quot;</span></span>
<span id=cb8-12><a href=#cb8-12 aria-hidden=true tabindex=-1></a><span class=cf>if</span> <span class=fu>grep</span> <span class=at>-ie</span> <span class=st>&#39;^#+options:&#39;</span> <span class=st>&quot;</span><span class=va>$orgfile</span><span class=st>&quot;</span> <span class=kw>|</span> <span class=fu>grep</span> <span class=st>&#39;toc:t&#39;</span><span class=op>&gt;</span>/dev/null<span class=kw>;</span> <span class=cf>then</span></span>
<span id=cb8-13><a href=#cb8-13 aria-hidden=true tabindex=-1></a>    <span class=va>tocoption</span><span class=op>=</span><span class=st>&quot;--toc&quot;</span></span>
<span id=cb8-14><a href=#cb8-14 aria-hidden=true tabindex=-1></a><span class=cf>fi</span></span>
<span id=cb8-15><a href=#cb8-15 aria-hidden=true tabindex=-1></a></span>
<span id=cb8-16><a href=#cb8-16 aria-hidden=true tabindex=-1></a><span class=bu>set</span> <span class=at>-x</span></span>
<span id=cb8-17><a href=#cb8-17 aria-hidden=true tabindex=-1></a><span class=ex>pandoc</span> <span class=va>$tocoption</span> <span class=dt>\</span></span>
<span id=cb8-18><a href=#cb8-18 aria-hidden=true tabindex=-1></a>       <span class=at>--template</span><span class=op>=</span><span class=st>&quot;</span><span class=va>$template</span><span class=st>&quot;</span> <span class=dt>\</span></span>
<span id=cb8-19><a href=#cb8-19 aria-hidden=true tabindex=-1></a>       <span class=at>--mathml</span> <span class=dt>\</span></span>
<span id=cb8-20><a href=#cb8-20 aria-hidden=true tabindex=-1></a>       <span class=at>--from</span> org <span class=dt>\</span></span>
<span id=cb8-21><a href=#cb8-21 aria-hidden=true tabindex=-1></a>       <span class=at>--to</span> html5 <span class=dt>\</span></span>
<span id=cb8-22><a href=#cb8-22 aria-hidden=true tabindex=-1></a>       <span class=at>--standalone</span> <span class=dt>\</span></span>
<span id=cb8-23><a href=#cb8-23 aria-hidden=true tabindex=-1></a>       <span class=va>$orgfile</span> <span class=dt>\</span></span>
<span id=cb8-24><a href=#cb8-24 aria-hidden=true tabindex=-1></a>       <span class=at>--output</span> <span class=st>&quot;</span><span class=va>$htmlfile</span><span class=st>&quot;</span></span></code></pre></div><p>Once generated I also minify the html file. And, that's it. But the
important part is that now, if I change my script or the template or the
file, it will generate the dependencies.<h2 id=indexes>Indexes</h2><p>We often need indexes to build a website. Typically to list the
latest articles, build the RSS file. So for sake of simplicity, I
decided to build my index as a set of XML files. Of course, this could
be optimizide, by using SQLite for example. But this will already be
really fast.<p>For every generated html file I will generate a clean XML file with
<code class=verbatim>hxclean</code>. Once cleaned, it will be easy to
access a specific node of in these XML files.<div class=sourceCode id=cb9><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id=cb9-1><a href=#cb9-1 aria-hidden=true tabindex=-1></a><span class=co># INDEXES</span></span>
<span id=cb9-2><a href=#cb9-2 aria-hidden=true tabindex=-1></a><span class=dt>SRC_POSTS_DIR </span><span class=ch>?=</span><span class=st> </span><span class=ch>$(</span><span class=dt>SRC_DIR</span><span class=ch>)</span><span class=st>/posts</span></span>
<span id=cb9-3><a href=#cb9-3 aria-hidden=true tabindex=-1></a><span class=dt>DST_POSTS_DIR </span><span class=ch>?=</span><span class=st> </span><span class=ch>$(</span><span class=dt>DST_DIR</span><span class=ch>)</span><span class=st>/posts</span></span>
<span id=cb9-4><a href=#cb9-4 aria-hidden=true tabindex=-1></a><span class=dt>SRC_POSTS_FILES </span><span class=ch>?=</span><span class=st> </span><span class=ch>$(</span><span class=kw>shell</span><span class=st> find </span><span class=ch>$(</span><span class=dt>SRC_POSTS_DIR</span><span class=ch>)</span><span class=st> -type f -name &quot;*</span><span class=ch>$(</span><span class=dt>EXT</span><span class=ch>)</span><span class=st>&quot;</span><span class=ch>)</span></span>
<span id=cb9-5><a href=#cb9-5 aria-hidden=true tabindex=-1></a><span class=dt>RSS_CACHE_DIR </span><span class=ch>?=</span><span class=st> </span><span class=ch>$(</span><span class=dt>CACHE_DIR</span><span class=ch>)</span><span class=st>/rss</span></span>
<span id=cb9-6><a href=#cb9-6 aria-hidden=true tabindex=-1></a><span class=dt>DST_XML_FILES </span><span class=ch>?=</span><span class=st> </span><span class=ch>$(</span><span class=kw>patsubst</span><span class=st> %.org</span><span class=kw>,</span><span class=st>%.xml</span><span class=kw>,</span><span class=st> \</span></span>
<span id=cb9-7><a href=#cb9-7 aria-hidden=true tabindex=-1></a><span class=st>                        </span><span class=ch>$(</span><span class=kw>patsubst</span><span class=st> </span><span class=ch>$(</span><span class=dt>SRC_POSTS_DIR</span><span class=ch>)</span><span class=st>/%</span><span class=kw>,</span><span class=ch>$(</span><span class=dt>RSS_CACHE_DIR</span><span class=ch>)</span><span class=st>/%</span><span class=kw>,</span><span class=st> \</span></span>
<span id=cb9-8><a href=#cb9-8 aria-hidden=true tabindex=-1></a><span class=st>                            </span><span class=ch>$(</span><span class=dt>SRC_POSTS_FILES</span><span class=ch>)))</span></span>
<span id=cb9-9><a href=#cb9-9 aria-hidden=true tabindex=-1></a><span class=dv>$(RSS_CACHE_DIR)/%.xml:</span><span class=dt> </span><span class=ch>$(</span><span class=dt>DST_POSTS_DIR</span><span class=ch>)</span><span class=dt>/%.html</span></span>
<span id=cb9-10><a href=#cb9-10 aria-hidden=true tabindex=-1></a>    <span class=ch>@</span><span class=fu>mkdir -p </span><span class=st>&quot;</span><span class=ch>$(</span><span class=kw>dir</span><span class=st> </span><span class=ch>$@)</span><span class=st>&quot;</span></span>
<span id=cb9-11><a href=#cb9-11 aria-hidden=true tabindex=-1></a>    hxclean <span class=st>&quot;</span><span class=ch>$&lt;</span><span class=st>&quot;</span> &gt; <span class=st>&quot;</span><span class=ch>$@</span><span class=st>&quot;</span></span>
<span id=cb9-12><a href=#cb9-12 aria-hidden=true tabindex=-1></a><span class=ot>.PHONY:</span><span class=dt> indexcache</span></span>
<span id=cb9-13><a href=#cb9-13 aria-hidden=true tabindex=-1></a><span class=dv>indexcache:</span><span class=dt> </span><span class=ch>$(</span><span class=dt>DST_XML_FILES</span><span class=ch>)</span></span>
<span id=cb9-14><a href=#cb9-14 aria-hidden=true tabindex=-1></a><span class=dt>ALL </span><span class=ch>+=</span><span class=st> indexcache</span></span></code></pre></div><p>This rule will generate for every file in <code class=verbatim>site/posts/*.html</code> a corresponding <code class=verbatim>xml</code> file (<code class=verbatim>hxclean</code>
takes an HTML an try its best to make an XML out of it).<h2 id=html-index>HTML Index</h2><p>Now we just want to generate the main <code class=verbatim>index.html</code> page at the root of the site. This
page should list all articles by date in reverse order.<p>The first step is to take advantage of the cache index. For every XML
file I generated before I should generate the small HTML block I want
for every entry. For this I use a script <code class=verbatim>mk-index-entry.sh</code>. He will use <code class=verbatim>hxselect</code> to retrieve the date and the title from
the cached XML files. Then generate a small file just containing the
date and the link.<p>Here is the block in the Makefile:<div class=sourceCode id=cb10><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id=cb10-1><a href=#cb10-1 aria-hidden=true tabindex=-1></a><span class=dt>DST_INDEX_FILES </span><span class=ch>?=</span><span class=st> </span><span class=ch>$(</span><span class=kw>patsubst</span><span class=st> %.xml</span><span class=kw>,</span><span class=st>%.index</span><span class=kw>,</span><span class=st> </span><span class=ch>$(</span><span class=dt>DST_XML_FILES</span><span class=ch>))</span></span>
<span id=cb10-2><a href=#cb10-2 aria-hidden=true tabindex=-1></a><span class=dt>MK_INDEX_ENTRY </span><span class=ch>:=</span><span class=st> ./engine/mk-index-entry.sh</span></span>
<span id=cb10-3><a href=#cb10-3 aria-hidden=true tabindex=-1></a><span class=dt>INDEX_CACHE_DIR </span><span class=ch>?=</span><span class=st> </span><span class=ch>$(</span><span class=dt>CACHE_DIR</span><span class=ch>)</span><span class=st>/rss</span></span>
<span id=cb10-4><a href=#cb10-4 aria-hidden=true tabindex=-1></a><span class=dv>$(INDEX_CACHE_DIR)/%.index:</span><span class=dt> </span><span class=ch>$(</span><span class=dt>INDEX_CACHE_DIR</span><span class=ch>)</span><span class=dt>/%.xml </span><span class=ch>$(</span><span class=dt>MK_INDEX_ENTRY</span><span class=ch>)</span></span>
<span id=cb10-5><a href=#cb10-5 aria-hidden=true tabindex=-1></a>    <span class=ch>@</span><span class=fu>mkdir -p </span><span class=ch>$(</span><span class=dt>INDEX_CACHE_DIR</span><span class=ch>)</span></span>
<span id=cb10-6><a href=#cb10-6 aria-hidden=true tabindex=-1></a>    <span class=ch>$(</span><span class=dt>MK_INDEX_ENTRY</span><span class=ch>)</span> <span class=st>&quot;</span><span class=ch>$&lt;</span><span class=st>&quot;</span> <span class=st>&quot;</span><span class=ch>$@</span><span class=st>&quot;</span></span></code></pre></div><p>It means: for every <code class=verbatim>.xml</code> file generate
a <code class=verbatim>.index</code> file with <code class=verbatim>mk-index-entry.sh</code>.<div class=sourceCode id=cb11 data-org-language=sh><pre class="sourceCode bash"><code class="sourceCode bash"><span id=cb11-1><a href=#cb11-1 aria-hidden=true tabindex=-1></a><span class=co>#!/usr/bin/env zsh</span></span>
<span id=cb11-2><a href=#cb11-2 aria-hidden=true tabindex=-1></a></span>
<span id=cb11-3><a href=#cb11-3 aria-hidden=true tabindex=-1></a><span class=co># prelude</span></span>
<span id=cb11-4><a href=#cb11-4 aria-hidden=true tabindex=-1></a><span class=bu>cd</span> <span class=st>&quot;</span><span class=va>$(</span><span class=fu>git</span> rev-parse <span class=at>--show-toplevel</span><span class=va>)</span><span class=st>&quot;</span> <span class=kw>||</span> <span class=bu>exit</span> 1</span>
<span id=cb11-5><a href=#cb11-5 aria-hidden=true tabindex=-1></a><span class=va>xfic</span><span class=op>=</span><span class=st>&quot;</span><span class=va>$1</span><span class=st>&quot;</span></span>
<span id=cb11-6><a href=#cb11-6 aria-hidden=true tabindex=-1></a><span class=va>dst</span><span class=op>=</span><span class=st>&quot;</span><span class=va>$2</span><span class=st>&quot;</span></span>
<span id=cb11-7><a href=#cb11-7 aria-hidden=true tabindex=-1></a><span class=va>indexdir</span><span class=op>=</span><span class=st>&quot;.cache/rss&quot;</span></span>
<span id=cb11-8><a href=#cb11-8 aria-hidden=true tabindex=-1></a></span>
<span id=cb11-9><a href=#cb11-9 aria-hidden=true tabindex=-1></a><span class=co># HTML Accessors (similar to CSS accessors)</span></span>
<span id=cb11-10><a href=#cb11-10 aria-hidden=true tabindex=-1></a><span class=va>dateaccessor</span><span class=op>=</span><span class=st>&#39;.yyydate&#39;</span></span>
<span id=cb11-11><a href=#cb11-11 aria-hidden=true tabindex=-1></a><span class=co># title and keyword shouldn&#39;t be changed</span></span>
<span id=cb11-12><a href=#cb11-12 aria-hidden=true tabindex=-1></a><span class=va>titleaccessor</span><span class=op>=</span><span class=st>&#39;title&#39;</span></span>
<span id=cb11-13><a href=#cb11-13 aria-hidden=true tabindex=-1></a><span class=fu>finddate()</span><span class=kw>{</span> <span class=op>&lt;</span> <span class=va>$1</span> <span class=ex>hxselect</span> <span class=at>-c</span> <span class=va>$dateaccessor</span> <span class=kw>|</span> <span class=fu>sed</span> <span class=st>&#39;s/\[//g;s/\]//g;s/ .*$//&#39;</span> }</span>
<span id=cb11-14><a href=#cb11-14 aria-hidden=true tabindex=-1></a><span class=fu>findtitle()</span><span class=kw>{</span> <span class=op>&lt;</span> <span class=va>$1</span> <span class=ex>hxselect</span> <span class=at>-c</span> <span class=va>$titleaccessor</span> }</span>
<span id=cb11-15><a href=#cb11-15 aria-hidden=true tabindex=-1></a></span>
<span id=cb11-16><a href=#cb11-16 aria-hidden=true tabindex=-1></a><span class=ex>autoload</span> <span class=at>-U</span> colors <span class=kw>&amp;&amp;</span> <span class=ex>colors</span></span>
<span id=cb11-17><a href=#cb11-17 aria-hidden=true tabindex=-1></a></span>
<span id=cb11-18><a href=#cb11-18 aria-hidden=true tabindex=-1></a><span class=va>blogfile</span><span class=op>=</span><span class=st>&quot;</span><span class=va>$(</span><span class=bu>echo</span> <span class=st>&quot;</span><span class=va>$xfic</span><span class=st>&quot;</span><span class=kw>|</span><span class=fu>sed</span> <span class=st>&#39;s#.xml$#.html#;s#^&#39;</span><span class=va>$indexdir</span><span class=st>&#39;/#posts/#&#39;</span><span class=va>)</span><span class=st>&quot;</span></span>
<span id=cb11-19><a href=#cb11-19 aria-hidden=true tabindex=-1></a><span class=bu>printf</span> <span class=st>&quot;%-30s&quot;</span> <span class=va>$blogfile</span></span>
<span id=cb11-20><a href=#cb11-20 aria-hidden=true tabindex=-1></a><span class=va>d</span><span class=op>=</span><span class=va>$(</span><span class=ex>finddate</span> <span class=va>$xfic)</span></span>
<span id=cb11-21><a href=#cb11-21 aria-hidden=true tabindex=-1></a><span class=bu>echo</span> <span class=at>-n</span> <span class=st>&quot; [</span><span class=va>$d</span><span class=st>]&quot;</span></span>
<span id=cb11-22><a href=#cb11-22 aria-hidden=true tabindex=-1></a><span class=va>rssdate</span><span class=op>=</span><span class=va>$(</span><span class=ex>formatdate</span> <span class=va>$d)</span></span>
<span id=cb11-23><a href=#cb11-23 aria-hidden=true tabindex=-1></a><span class=va>title</span><span class=op>=</span><span class=va>$(</span><span class=ex>findtitle</span> <span class=va>$xfic)</span></span>
<span id=cb11-24><a href=#cb11-24 aria-hidden=true tabindex=-1></a><span class=va>keywords</span><span class=op>=</span><span class=va>(</span> <span class=va>$(</span><span class=ex>findkeywords</span> <span class=va>$xfic)</span> <span class=va>)</span></span>
<span id=cb11-25><a href=#cb11-25 aria-hidden=true tabindex=-1></a><span class=bu>printf</span> <span class=st>&quot;: %-55s&quot;</span> <span class=st>&quot;</span><span class=va>$title</span><span class=st> (</span><span class=va>$keywords</span><span class=st>)&quot;</span></span>
<span id=cb11-26><a href=#cb11-26 aria-hidden=true tabindex=-1></a><span class=kw>{</span> <span class=bu>printf</span> <span class=st>&quot;</span><span class=dt>\\</span><span class=st>n&lt;li&gt;&quot;</span></span>
<span id=cb11-27><a href=#cb11-27 aria-hidden=true tabindex=-1></a>  <span class=bu>printf</span> <span class=st>&quot;</span><span class=dt>\\</span><span class=st>n&lt;span class=</span><span class=dt>\&quot;</span><span class=st>pubDate</span><span class=dt>\&quot;</span><span class=st>&gt;%s&lt;/span&gt;&quot;</span> <span class=st>&quot;</span><span class=va>$d</span><span class=st>&quot;</span></span>
<span id=cb11-28><a href=#cb11-28 aria-hidden=true tabindex=-1></a>  <span class=bu>printf</span> <span class=st>&quot;</span><span class=dt>\\</span><span class=st>n&lt;a href=</span><span class=dt>\&quot;</span><span class=st>%s</span><span class=dt>\&quot;</span><span class=st>&gt;%s&lt;/a&gt;&quot;</span> <span class=st>&quot;</span><span class=va>${blogfile}</span><span class=st>&quot;</span> <span class=st>&quot;</span><span class=va>$title</span><span class=st>&quot;</span></span>
<span id=cb11-29><a href=#cb11-29 aria-hidden=true tabindex=-1></a>  <span class=bu>printf</span> <span class=st>&quot;</span><span class=dt>\\</span><span class=st>n&lt;/li&gt;</span><span class=dt>\\</span><span class=st>n</span><span class=dt>\\</span><span class=st>n&quot;</span></span>
<span id=cb11-30><a href=#cb11-30 aria-hidden=true tabindex=-1></a><span class=kw>}</span> <span class=op>&gt;&gt;</span> <span class=va>${dst}</span></span>
<span id=cb11-31><a href=#cb11-31 aria-hidden=true tabindex=-1></a></span>
<span id=cb11-32><a href=#cb11-32 aria-hidden=true tabindex=-1></a><span class=bu>echo</span> <span class=st>&quot; [</span><span class=va>${fg</span><span class=op>[</span>green<span class=op>]</span><span class=va>}</span><span class=st>OK</span><span class=va>${reset_color}</span><span class=st>]&quot;</span></span></code></pre></div><p>Then I use these intermediate files to generate a single bigger index
file.<div class=sourceCode id=cb12><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id=cb12-1><a href=#cb12-1 aria-hidden=true tabindex=-1></a><span class=dt>HTML_INDEX </span><span class=ch>:=</span><span class=st> </span><span class=ch>$(</span><span class=dt>DST_DIR</span><span class=ch>)</span><span class=st>/index.html</span></span>
<span id=cb12-2><a href=#cb12-2 aria-hidden=true tabindex=-1></a><span class=dt>MKINDEX </span><span class=ch>:=</span><span class=st> engine/mk-index.sh</span></span>
<span id=cb12-3><a href=#cb12-3 aria-hidden=true tabindex=-1></a><span class=dt>INDEX_TEMPLATE </span><span class=ch>?=</span><span class=st> templates/index.html</span></span>
<span id=cb12-4><a href=#cb12-4 aria-hidden=true tabindex=-1></a><span class=dv>$(HTML_INDEX):</span><span class=dt> </span><span class=ch>$(</span><span class=dt>DST_INDEX_FILES</span><span class=ch>)</span><span class=dt> </span><span class=ch>$(</span><span class=dt>MKINDEX</span><span class=ch>)</span><span class=dt> </span><span class=ch>$(</span><span class=dt>INDEX_TEMPLATE</span><span class=ch>)</span></span>
<span id=cb12-5><a href=#cb12-5 aria-hidden=true tabindex=-1></a>    <span class=ch>@</span><span class=fu>mkdir -p </span><span class=ch>$(</span><span class=dt>DST_DIR</span><span class=ch>)</span></span>
<span id=cb12-6><a href=#cb12-6 aria-hidden=true tabindex=-1></a>    <span class=ch>$(</span><span class=dt>MKINDEX</span><span class=ch>)</span></span>
<span id=cb12-7><a href=#cb12-7 aria-hidden=true tabindex=-1></a><span class=ot>.PHONY:</span><span class=dt> index</span></span>
<span id=cb12-8><a href=#cb12-8 aria-hidden=true tabindex=-1></a><span class=dv>index:</span><span class=dt> </span><span class=ch>$(</span><span class=dt>HTML_INDEX</span><span class=ch>)</span></span>
<span id=cb12-9><a href=#cb12-9 aria-hidden=true tabindex=-1></a><span class=dt>ALL </span><span class=ch>+=</span><span class=st> index</span></span></code></pre></div><p>This script is a big one, but it is not that complex. For every file,
I generate a new file <code class=verbatim>DATE-dirname</code>. I sort
them in reverse order and put their content in the middle of an HTML
file.<p>Important note: this file updates only if the index change.<p>The first part of the script creates files with the creation date in
their metadatas. The created file name will contain the creation date,
this will be helpful later.<div class=sourceCode id=cb13 data-org-language=sh><pre class="sourceCode bash"><code class="sourceCode bash"><span id=cb13-1><a href=#cb13-1 aria-hidden=true tabindex=-1></a><span class=co>#!/usr/bin/env zsh</span></span>
<span id=cb13-2><a href=#cb13-2 aria-hidden=true tabindex=-1></a></span>
<span id=cb13-3><a href=#cb13-3 aria-hidden=true tabindex=-1></a><span class=ex>autoload</span> <span class=at>-U</span> colors <span class=kw>&amp;&amp;</span> <span class=ex>colors</span></span>
<span id=cb13-4><a href=#cb13-4 aria-hidden=true tabindex=-1></a><span class=bu>cd</span> <span class=st>&quot;</span><span class=va>$(</span><span class=fu>git</span> rev-parse <span class=at>--show-toplevel</span><span class=va>)</span><span class=st>&quot;</span> <span class=kw>||</span> <span class=bu>exit</span> 1</span>
<span id=cb13-5><a href=#cb13-5 aria-hidden=true tabindex=-1></a><span class=co># Directory</span></span>
<span id=cb13-6><a href=#cb13-6 aria-hidden=true tabindex=-1></a><span class=va>webdir</span><span class=op>=</span><span class=st>&quot;_site&quot;</span></span>
<span id=cb13-7><a href=#cb13-7 aria-hidden=true tabindex=-1></a><span class=va>indexfile</span><span class=op>=</span><span class=st>&quot;</span><span class=va>$webdir</span><span class=st>/index.html&quot;</span></span>
<span id=cb13-8><a href=#cb13-8 aria-hidden=true tabindex=-1></a><span class=va>indexdir</span><span class=op>=</span><span class=st>&quot;.cache/rss&quot;</span></span>
<span id=cb13-9><a href=#cb13-9 aria-hidden=true tabindex=-1></a><span class=va>tmpdir</span><span class=op>=</span><span class=va>$(</span><span class=fu>mktemp</span> <span class=at>-d</span><span class=va>)</span></span>
<span id=cb13-10><a href=#cb13-10 aria-hidden=true tabindex=-1></a></span>
<span id=cb13-11><a href=#cb13-11 aria-hidden=true tabindex=-1></a><span class=bu>echo</span> <span class=st>&quot;Publishing&quot;</span></span>
<span id=cb13-12><a href=#cb13-12 aria-hidden=true tabindex=-1></a></span>
<span id=cb13-13><a href=#cb13-13 aria-hidden=true tabindex=-1></a><span class=va>dateaccessor</span><span class=op>=</span><span class=st>&#39;.pubDate&#39;</span></span>
<span id=cb13-14><a href=#cb13-14 aria-hidden=true tabindex=-1></a><span class=fu>finddate()</span><span class=kw>{</span> <span class=op>&lt;</span> <span class=va>$1</span> <span class=ex>hxselect</span> <span class=at>-c</span> <span class=va>$dateaccessor</span> }</span>
<span id=cb13-15><a href=#cb13-15 aria-hidden=true tabindex=-1></a><span class=co># generate files with &lt;DATE&gt;-&lt;FILENAME&gt;.index</span></span>
<span id=cb13-16><a href=#cb13-16 aria-hidden=true tabindex=-1></a><span class=cf>for</span> fic <span class=kw>in</span> <span class=va>$indexdir</span>/<span class=pp>**</span>/<span class=pp>*</span>.index<span class=kw>;</span> <span class=cf>do</span></span>
<span id=cb13-17><a href=#cb13-17 aria-hidden=true tabindex=-1></a>    <span class=va>d</span><span class=op>=</span><span class=va>$(</span><span class=ex>finddate</span> <span class=va>$fic)</span></span>
<span id=cb13-18><a href=#cb13-18 aria-hidden=true tabindex=-1></a>    <span class=bu>echo</span> <span class=st>&quot;</span><span class=va>${$</span><span class=er>{fic:h</span><span class=va>}</span><span class=st>:t} [</span><span class=va>$d</span><span class=st>]&quot;</span></span>
<span id=cb13-19><a href=#cb13-19 aria-hidden=true tabindex=-1></a>    <span class=fu>cp</span> <span class=va>$fic</span> <span class=va>$tmpdir</span>/<span class=va>$d</span>-<span class=va>${$</span><span class=er>{fic:h</span><span class=va>}</span>:t}.index</span>
<span id=cb13-20><a href=#cb13-20 aria-hidden=true tabindex=-1></a><span class=cf>done</span></span></code></pre></div><p>Then I use these files to generate a file that will contain the <code class=verbatim>body</code> of the HTML.<div class=sourceCode id=cb14 data-org-language=sh><pre class="sourceCode bash"><code class="sourceCode bash"><span id=cb14-1><a href=#cb14-1 aria-hidden=true tabindex=-1></a><span class=co># for every post in reverse order</span></span>
<span id=cb14-2><a href=#cb14-2 aria-hidden=true tabindex=-1></a><span class=co># generate the body (there is some logic to group by year)</span></span>
<span id=cb14-3><a href=#cb14-3 aria-hidden=true tabindex=-1></a><span class=va>previousyear</span><span class=op>=</span><span class=st>&quot;&quot;</span></span>
<span id=cb14-4><a href=#cb14-4 aria-hidden=true tabindex=-1></a><span class=cf>for</span> fic <span class=kw>in</span> <span class=va>$(</span><span class=fu>ls</span> <span class=va>$tmpdir</span>/<span class=pp>*</span>.index <span class=kw>|</span> <span class=fu>sort</span> <span class=at>-r</span><span class=va>)</span><span class=kw>;</span> <span class=cf>do</span></span>
<span id=cb14-5><a href=#cb14-5 aria-hidden=true tabindex=-1></a>    <span class=va>d</span><span class=op>=</span><span class=va>$(</span><span class=ex>finddate</span> <span class=va>$fic)</span></span>
<span id=cb14-6><a href=#cb14-6 aria-hidden=true tabindex=-1></a>    <span class=va>year</span><span class=op>=</span><span class=va>$(</span> <span class=bu>echo</span> <span class=st>&quot;</span><span class=va>$d</span><span class=st>&quot;</span> <span class=kw>|</span> <span class=fu>perl</span> <span class=at>-pe</span> <span class=st>&#39;s#(\d{4})-.*#$1#&#39;</span><span class=va>)</span></span>
<span id=cb14-7><a href=#cb14-7 aria-hidden=true tabindex=-1></a>    <span class=cf>if</span> <span class=kw>((</span> <span class=va>year</span> <span class=op>!=</span> <span class=va>previousyear</span> <span class=kw>));</span> <span class=cf>then</span></span>
<span id=cb14-8><a href=#cb14-8 aria-hidden=true tabindex=-1></a>        <span class=cf>if</span> <span class=kw>((</span> <span class=va>previousyear</span> <span class=op>&gt;</span> <span class=dv>0</span> <span class=kw>));</span> <span class=cf>then</span></span>
<span id=cb14-9><a href=#cb14-9 aria-hidden=true tabindex=-1></a>            <span class=bu>echo</span> <span class=st>&quot;&lt;/ul&gt;&quot;</span> <span class=op>&gt;&gt;</span> <span class=va>$tmpdir</span>/index</span>
<span id=cb14-10><a href=#cb14-10 aria-hidden=true tabindex=-1></a>        <span class=cf>fi</span></span>
<span id=cb14-11><a href=#cb14-11 aria-hidden=true tabindex=-1></a>        <span class=va>previousyear</span><span class=op>=</span><span class=va>$year</span></span>
<span id=cb14-12><a href=#cb14-12 aria-hidden=true tabindex=-1></a>        <span class=bu>echo</span> <span class=st>&quot;&lt;h3 name=</span><span class=dt>\&quot;</span><span class=va>${year}</span><span class=dt>\&quot;</span><span class=st> &gt;</span><span class=va>${year}</span><span class=st>&lt;/h3&gt;&lt;ul&gt;&quot;</span> <span class=op>&gt;&gt;</span> <span class=va>$tmpdir</span>/index</span>
<span id=cb14-13><a href=#cb14-13 aria-hidden=true tabindex=-1></a>    <span class=cf>fi</span></span>
<span id=cb14-14><a href=#cb14-14 aria-hidden=true tabindex=-1></a>    <span class=fu>cat</span> <span class=va>$fic</span> <span class=op>&gt;&gt;</span> <span class=va>$tmpdir</span>/index</span>
<span id=cb14-15><a href=#cb14-15 aria-hidden=true tabindex=-1></a><span class=cf>done</span></span>
<span id=cb14-16><a href=#cb14-16 aria-hidden=true tabindex=-1></a><span class=bu>echo</span> <span class=st>&quot;&lt;/ul&gt;&quot;</span> <span class=op>&gt;&gt;</span> <span class=va>$tmpdir</span>/index</span></code></pre></div><p>And finally, I render the HTML using a template within a shell
script:<div class=sourceCode id=cb15 data-org-language=sh><pre class="sourceCode bash"><code class="sourceCode bash"><span id=cb15-1><a href=#cb15-1 aria-hidden=true tabindex=-1></a><span class=va>title</span><span class=op>=</span><span class=st>&quot;Y&quot;</span></span>
<span id=cb15-2><a href=#cb15-2 aria-hidden=true tabindex=-1></a><span class=va>description</span><span class=op>=</span><span class=st>&quot;Most recent articles&quot;</span></span>
<span id=cb15-3><a href=#cb15-3 aria-hidden=true tabindex=-1></a><span class=va>author</span><span class=op>=</span><span class=st>&quot;Yann Esposito&quot;</span></span>
<span id=cb15-4><a href=#cb15-4 aria-hidden=true tabindex=-1></a><span class=va>body</span><span class=op>=</span><span class=va>$(</span><span class=op>&lt;</span> <span class=va>$tmpdir</span>/index<span class=va>)</span></span>
<span id=cb15-5><a href=#cb15-5 aria-hidden=true tabindex=-1></a><span class=va>date</span><span class=op>=</span><span class=va>$(LC_TIME</span><span class=op>=</span>en_US <span class=fu>date</span> +<span class=st>&#39;%Y-%m-%d&#39;</span><span class=va>)</span></span>
<span id=cb15-6><a href=#cb15-6 aria-hidden=true tabindex=-1></a></span>
<span id=cb15-7><a href=#cb15-7 aria-hidden=true tabindex=-1></a><span class=co># A neat trick to use pandoc template within a shell script</span></span>
<span id=cb15-8><a href=#cb15-8 aria-hidden=true tabindex=-1></a><span class=co># the pandoc templates use $x$ format, we replace it by just $x</span></span>
<span id=cb15-9><a href=#cb15-9 aria-hidden=true tabindex=-1></a><span class=co># to be used with envsubst</span></span>
<span id=cb15-10><a href=#cb15-10 aria-hidden=true tabindex=-1></a><span class=va>template</span><span class=op>=</span><span class=va>$(</span><span class=op>&lt;</span> templates/index.html <span class=kw>|</span> <span class=dt>\</span></span>
<span id=cb15-11><a href=#cb15-11 aria-hidden=true tabindex=-1></a>    <span class=fu>sed</span> <span class=st>&#39;s/\$\(header-includes\|table-of-content\)\$//&#39;</span> <span class=kw>|</span> <span class=dt>\</span></span>
<span id=cb15-12><a href=#cb15-12 aria-hidden=true tabindex=-1></a>    <span class=fu>sed</span> <span class=st>&#39;s/\$if.*\$//&#39;</span> <span class=kw>|</span> <span class=dt>\</span></span>
<span id=cb15-13><a href=#cb15-13 aria-hidden=true tabindex=-1></a>    <span class=fu>perl</span> <span class=at>-pe</span> <span class=st>&#39;s#(\$[^\$]*)\$#$1#g&#39;</span> <span class=va>)</span></span>
<span id=cb15-14><a href=#cb15-14 aria-hidden=true tabindex=-1></a><span class=kw>{</span></span>
<span id=cb15-15><a href=#cb15-15 aria-hidden=true tabindex=-1></a>    <span class=bu>export</span> <span class=va>title</span></span>
<span id=cb15-16><a href=#cb15-16 aria-hidden=true tabindex=-1></a>    <span class=bu>export</span> <span class=va>author</span></span>
<span id=cb15-17><a href=#cb15-17 aria-hidden=true tabindex=-1></a>    <span class=bu>export</span> <span class=va>description</span></span>
<span id=cb15-18><a href=#cb15-18 aria-hidden=true tabindex=-1></a>    <span class=bu>export</span> <span class=va>date</span></span>
<span id=cb15-19><a href=#cb15-19 aria-hidden=true tabindex=-1></a>    <span class=bu>export</span> <span class=va>body</span></span>
<span id=cb15-20><a href=#cb15-20 aria-hidden=true tabindex=-1></a>    <span class=bu>echo</span> <span class=va>${template}</span> <span class=kw>|</span> <span class=ex>envsubst</span></span>
<span id=cb15-21><a href=#cb15-21 aria-hidden=true tabindex=-1></a><span class=kw>}</span> <span class=op>&gt;</span> <span class=st>&quot;</span><span class=va>$indexfile</span><span class=st>&quot;</span></span>
<span id=cb15-22><a href=#cb15-22 aria-hidden=true tabindex=-1></a></span>
<span id=cb15-23><a href=#cb15-23 aria-hidden=true tabindex=-1></a><span class=fu>rm</span> <span class=at>-rf</span> <span class=va>$tmpdir</span></span>
<span id=cb15-24><a href=#cb15-24 aria-hidden=true tabindex=-1></a><span class=bu>echo</span> <span class=st>&quot;* HTML INDEX [done]&quot;</span></span></code></pre></div><h2 id=rss>RSS</h2><p>My RSS generation is similar to the system I used to generate the
index file. I just slightly improved the rules.<p>The <code class=verbatim>Makefile</code> blocks look like:<div class=sourceCode id=cb16><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id=cb16-1><a href=#cb16-1 aria-hidden=true tabindex=-1></a><span class=co># RSS</span></span>
<span id=cb16-2><a href=#cb16-2 aria-hidden=true tabindex=-1></a><span class=dt>DST_RSS_FILES </span><span class=ch>?=</span><span class=st> </span><span class=ch>$(</span><span class=kw>patsubst</span><span class=st> %.xml</span><span class=kw>,</span><span class=st>%.rss</span><span class=kw>,</span><span class=st> </span><span class=ch>$(</span><span class=dt>DST_XML_FILES</span><span class=ch>))</span></span>
<span id=cb16-3><a href=#cb16-3 aria-hidden=true tabindex=-1></a><span class=dt>MK_RSS_ENTRY </span><span class=ch>:=</span><span class=st> ./engine/mk-rss-entry.sh</span></span>
<span id=cb16-4><a href=#cb16-4 aria-hidden=true tabindex=-1></a><span class=dv>$(RSS_CACHE_DIR)/%.rss:</span><span class=dt> </span><span class=ch>$(</span><span class=dt>RSS_CACHE_DIR</span><span class=ch>)</span><span class=dt>/%.xml </span><span class=ch>$(</span><span class=dt>MK_RSS_ENTRY</span><span class=ch>)</span></span>
<span id=cb16-5><a href=#cb16-5 aria-hidden=true tabindex=-1></a>    <span class=ch>@</span><span class=fu>mkdir -p </span><span class=ch>$(</span><span class=dt>RSS_CACHE_DIR</span><span class=ch>)</span></span>
<span id=cb16-6><a href=#cb16-6 aria-hidden=true tabindex=-1></a>    <span class=ch>$(</span><span class=dt>MK_RSS_ENTRY</span><span class=ch>)</span> <span class=st>&quot;</span><span class=ch>$&lt;</span><span class=st>&quot;</span> <span class=st>&quot;</span><span class=ch>$@</span><span class=st>&quot;</span></span>
<span id=cb16-7><a href=#cb16-7 aria-hidden=true tabindex=-1></a></span>
<span id=cb16-8><a href=#cb16-8 aria-hidden=true tabindex=-1></a><span class=dt>RSS </span><span class=ch>:=</span><span class=st> </span><span class=ch>$(</span><span class=dt>DST_DIR</span><span class=ch>)</span><span class=st>/rss.xml</span></span>
<span id=cb16-9><a href=#cb16-9 aria-hidden=true tabindex=-1></a><span class=dt>MKRSS </span><span class=ch>:=</span><span class=st> engine/mkrss.sh</span></span>
<span id=cb16-10><a href=#cb16-10 aria-hidden=true tabindex=-1></a><span class=dv>$(RSS):</span><span class=dt> </span><span class=ch>$(</span><span class=dt>DST_RSS_FILES</span><span class=ch>)</span><span class=dt> </span><span class=ch>$(</span><span class=dt>MKRSS</span><span class=ch>)</span></span>
<span id=cb16-11><a href=#cb16-11 aria-hidden=true tabindex=-1></a>    <span class=ch>$(</span><span class=dt>MKRSS</span><span class=ch>)</span></span>
<span id=cb16-12><a href=#cb16-12 aria-hidden=true tabindex=-1></a></span>
<span id=cb16-13><a href=#cb16-13 aria-hidden=true tabindex=-1></a><span class=ot>.PHONY:</span><span class=dt> rss</span></span>
<span id=cb16-14><a href=#cb16-14 aria-hidden=true tabindex=-1></a><span class=dv>rss:</span><span class=dt> </span><span class=ch>$(</span><span class=dt>RSS</span><span class=ch>)</span></span>
<span id=cb16-15><a href=#cb16-15 aria-hidden=true tabindex=-1></a><span class=dt>ALL </span><span class=ch>+=</span><span class=st> rss</span></span></code></pre></div><h2 id=gemini>Gemini</h2><p>I wrote a minimal script to transform my org files to gemini files. I
also need to generate an index and an atom file for gemini:<div class=sourceCode id=cb17><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id=cb17-1><a href=#cb17-1 aria-hidden=true tabindex=-1></a><span class=co># ORG -&gt; GEMINI</span></span>
<span id=cb17-2><a href=#cb17-2 aria-hidden=true tabindex=-1></a><span class=dt>EXT </span><span class=ch>:=</span><span class=st> .org</span></span>
<span id=cb17-3><a href=#cb17-3 aria-hidden=true tabindex=-1></a><span class=dt>SRC_GMI_FILES </span><span class=ch>?=</span><span class=st> </span><span class=ch>$(</span><span class=kw>shell</span><span class=st> find </span><span class=ch>$(</span><span class=dt>SRC_DIR</span><span class=ch>)</span><span class=st> -type f -name &quot;*</span><span class=ch>$(</span><span class=dt>EXT</span><span class=ch>)</span><span class=st>&quot; </span><span class=ch>$(</span><span class=dt>NO_DRAFT</span><span class=ch>))</span></span>
<span id=cb17-4><a href=#cb17-4 aria-hidden=true tabindex=-1></a><span class=dt>DST_GMI_FILES </span><span class=ch>?=</span><span class=st> </span><span class=ch>$(</span><span class=kw>subst</span><span class=st> </span><span class=ch>$(</span><span class=dt>EXT</span><span class=ch>)</span><span class=kw>,</span><span class=st>.gmi</span><span class=kw>,</span><span class=st> \</span></span>
<span id=cb17-5><a href=#cb17-5 aria-hidden=true tabindex=-1></a><span class=st>                        </span><span class=ch>$(</span><span class=kw>patsubst</span><span class=st> </span><span class=ch>$(</span><span class=dt>SRC_DIR</span><span class=ch>)</span><span class=st>/%</span><span class=kw>,</span><span class=ch>$(</span><span class=dt>DST_DIR</span><span class=ch>)</span><span class=st>/%</span><span class=kw>,</span><span class=st> \</span></span>
<span id=cb17-6><a href=#cb17-6 aria-hidden=true tabindex=-1></a><span class=st>                            </span><span class=ch>$(</span><span class=dt>SRC_GMI_FILES</span><span class=ch>)))</span></span>
<span id=cb17-7><a href=#cb17-7 aria-hidden=true tabindex=-1></a><span class=dt>GMI </span><span class=ch>:=</span><span class=st> engine/org2gemini.sh</span></span>
<span id=cb17-8><a href=#cb17-8 aria-hidden=true tabindex=-1></a><span class=dv>$(DST_DIR)/%.gmi:</span><span class=dt> </span><span class=ch>$(</span><span class=dt>SRC_DIR</span><span class=ch>)</span><span class=dt>/%.org </span><span class=ch>$(</span><span class=dt>GMI</span><span class=ch>)</span><span class=dt> engine/org2gemini_step1.sh</span></span>
<span id=cb17-9><a href=#cb17-9 aria-hidden=true tabindex=-1></a>    <span class=ch>@</span><span class=fu>mkdir -p </span><span class=ch>$(</span><span class=kw>dir</span><span class=st> </span><span class=ch>$@)</span></span>
<span id=cb17-10><a href=#cb17-10 aria-hidden=true tabindex=-1></a>    <span class=ch>$(</span><span class=dt>GMI</span><span class=ch>)</span> <span class=st>&quot;</span><span class=ch>$&lt;</span><span class=st>&quot;</span> <span class=st>&quot;</span><span class=ch>$@</span><span class=st>&quot;</span></span>
<span id=cb17-11><a href=#cb17-11 aria-hidden=true tabindex=-1></a><span class=dt>ALL </span><span class=ch>+=</span><span class=st> </span><span class=ch>$(</span><span class=dt>DST_GMI_FILES</span><span class=ch>)</span></span>
<span id=cb17-12><a href=#cb17-12 aria-hidden=true tabindex=-1></a><span class=ot>.PHONY:</span><span class=dt> gmi</span></span>
<span id=cb17-13><a href=#cb17-13 aria-hidden=true tabindex=-1></a><span class=dv>gmi:</span><span class=dt> </span><span class=ch>$(</span><span class=dt>DST_GMI_FILES</span><span class=ch>)</span></span>
<span id=cb17-14><a href=#cb17-14 aria-hidden=true tabindex=-1></a></span>
<span id=cb17-15><a href=#cb17-15 aria-hidden=true tabindex=-1></a><span class=co># GEMINI INDEX</span></span>
<span id=cb17-16><a href=#cb17-16 aria-hidden=true tabindex=-1></a><span class=dt>GMI_INDEX </span><span class=ch>:=</span><span class=st> </span><span class=ch>$(</span><span class=dt>DST_DIR</span><span class=ch>)</span><span class=st>/index.gmi</span></span>
<span id=cb17-17><a href=#cb17-17 aria-hidden=true tabindex=-1></a><span class=dt>MK_GMI_INDEX </span><span class=ch>:=</span><span class=st> engine/mk-gemini-index.sh</span></span>
<span id=cb17-18><a href=#cb17-18 aria-hidden=true tabindex=-1></a><span class=dv>$(GMI_INDEX):</span><span class=dt> </span><span class=ch>$(</span><span class=dt>DST_GMI_FILES</span><span class=ch>)</span><span class=dt> </span><span class=ch>$(</span><span class=dt>MK_GMI_INDEX</span><span class=ch>)</span></span>
<span id=cb17-19><a href=#cb17-19 aria-hidden=true tabindex=-1></a>    <span class=ch>@</span><span class=fu>mkdir -p </span><span class=ch>$(</span><span class=dt>DST_DIR</span><span class=ch>)</span></span>
<span id=cb17-20><a href=#cb17-20 aria-hidden=true tabindex=-1></a>    <span class=ch>$(</span><span class=dt>MK_GMI_INDEX</span><span class=ch>)</span></span>
<span id=cb17-21><a href=#cb17-21 aria-hidden=true tabindex=-1></a><span class=dt>ALL </span><span class=ch>+=</span><span class=st> </span><span class=ch>$(</span><span class=dt>GMI_INDEX</span><span class=ch>)</span></span>
<span id=cb17-22><a href=#cb17-22 aria-hidden=true tabindex=-1></a><span class=ot>.PHONY:</span><span class=dt> gmi-index</span></span>
<span id=cb17-23><a href=#cb17-23 aria-hidden=true tabindex=-1></a><span class=dv>gmi-index:</span><span class=dt> </span><span class=ch>$(</span><span class=dt>GMI_INDEX</span><span class=ch>)</span></span>
<span id=cb17-24><a href=#cb17-24 aria-hidden=true tabindex=-1></a></span>
<span id=cb17-25><a href=#cb17-25 aria-hidden=true tabindex=-1></a><span class=co># RSS</span></span>
<span id=cb17-26><a href=#cb17-26 aria-hidden=true tabindex=-1></a><span class=dt>GEM_ATOM </span><span class=ch>:=</span><span class=st> </span><span class=ch>$(</span><span class=dt>DST_DIR</span><span class=ch>)</span><span class=st>/gem-atom.xml</span></span>
<span id=cb17-27><a href=#cb17-27 aria-hidden=true tabindex=-1></a><span class=dt>MK_GEMINI_ATOM </span><span class=ch>:=</span><span class=st> engine/mk-gemini-atom.sh</span></span>
<span id=cb17-28><a href=#cb17-28 aria-hidden=true tabindex=-1></a><span class=dv>$(GEM_ATOM):</span><span class=dt> </span><span class=ch>$(</span><span class=dt>DST_GMI_FILES</span><span class=ch>)</span><span class=dt> </span><span class=ch>$(</span><span class=dt>MK_GEMINI_ATOM</span><span class=ch>)</span></span>
<span id=cb17-29><a href=#cb17-29 aria-hidden=true tabindex=-1></a>    <span class=ch>$(</span><span class=dt>MK_GEMINI_ATOM</span><span class=ch>)</span></span>
<span id=cb17-30><a href=#cb17-30 aria-hidden=true tabindex=-1></a><span class=dt>ALL </span><span class=ch>+=</span><span class=st> </span><span class=ch>$(</span><span class=dt>GEM_ATOM</span><span class=ch>)</span></span>
<span id=cb17-31><a href=#cb17-31 aria-hidden=true tabindex=-1></a><span class=ot>.PHONY:</span><span class=dt> gmi-atom</span></span>
<span id=cb17-32><a href=#cb17-32 aria-hidden=true tabindex=-1></a><span class=dv>gmi-atom:</span><span class=dt> </span><span class=ch>$(</span><span class=dt>GMI_ATOM</span><span class=ch>)</span></span>
<span id=cb17-33><a href=#cb17-33 aria-hidden=true tabindex=-1></a></span>
<span id=cb17-34><a href=#cb17-34 aria-hidden=true tabindex=-1></a><span class=ot>.PHONY:</span><span class=dt> gemini</span></span>
<span id=cb17-35><a href=#cb17-35 aria-hidden=true tabindex=-1></a><span class=dv>gemini:</span><span class=dt> </span><span class=ch>$(</span><span class=dt>DST_GMI_FILES</span><span class=ch>)</span><span class=dt> </span><span class=ch>$(</span><span class=dt>GMI_INDEX</span><span class=ch>)</span><span class=dt> </span><span class=ch>$(</span><span class=dt>GEM_ATOM</span><span class=ch>)</span></span></code></pre></div><h2 id=images>Images</h2><p>For images, I try to compress them all with imagemagick.<div class=sourceCode id=cb18><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id=cb18-1><a href=#cb18-1 aria-hidden=true tabindex=-1></a><span class=co># Images</span></span>
<span id=cb18-2><a href=#cb18-2 aria-hidden=true tabindex=-1></a><span class=dt>SRC_IMG_FILES </span><span class=ch>?=</span><span class=st> </span><span class=ch>$(</span><span class=kw>shell</span><span class=st> find </span><span class=ch>$(</span><span class=dt>SRC_DIR</span><span class=ch>)</span><span class=st> -type f -name &quot;*.jpg&quot; -or -name &quot;*.jpeg&quot; -or -name &quot;*.gif&quot; -or -name &quot;*.png&quot;</span><span class=ch>)</span></span>
<span id=cb18-3><a href=#cb18-3 aria-hidden=true tabindex=-1></a><span class=dt>DST_IMG_FILES </span><span class=ch>?=</span><span class=st> </span><span class=ch>$(</span><span class=kw>patsubst</span><span class=st> </span><span class=ch>$(</span><span class=dt>SRC_DIR</span><span class=ch>)</span><span class=st>/%</span><span class=kw>,</span><span class=ch>$(</span><span class=dt>DST_DIR</span><span class=ch>)</span><span class=st>/%</span><span class=kw>,</span><span class=st> </span><span class=ch>$(</span><span class=dt>SRC_IMG_FILES</span><span class=ch>))</span></span>
<span id=cb18-4><a href=#cb18-4 aria-hidden=true tabindex=-1></a></span>
<span id=cb18-5><a href=#cb18-5 aria-hidden=true tabindex=-1></a><span class=dv>$(DST_DIR)/%.jpg:</span><span class=dt> </span><span class=ch>$(</span><span class=dt>SRC_DIR</span><span class=ch>)</span><span class=dt>/%.jpg</span></span>
<span id=cb18-6><a href=#cb18-6 aria-hidden=true tabindex=-1></a>    <span class=ch>@</span><span class=fu>mkdir -p </span><span class=ch>$(</span><span class=kw>dir</span><span class=st> </span><span class=ch>$@)</span></span>
<span id=cb18-7><a href=#cb18-7 aria-hidden=true tabindex=-1></a>    convert <span class=st>&quot;</span><span class=ch>$&lt;</span><span class=st>&quot;</span> -quality 50 -resize 800x800\&gt; <span class=st>&quot;</span><span class=ch>$@</span><span class=st>&quot;</span></span>
<span id=cb18-8><a href=#cb18-8 aria-hidden=true tabindex=-1></a></span>
<span id=cb18-9><a href=#cb18-9 aria-hidden=true tabindex=-1></a><span class=dv>$(DST_DIR)/%.jpg:</span><span class=dt> </span><span class=ch>$(</span><span class=dt>SRC_DIR</span><span class=ch>)</span><span class=dt>/%.jpeg</span></span>
<span id=cb18-10><a href=#cb18-10 aria-hidden=true tabindex=-1></a>    <span class=ch>@</span><span class=fu>mkdir -p </span><span class=ch>$(</span><span class=kw>dir</span><span class=st> </span><span class=ch>$@)</span></span>
<span id=cb18-11><a href=#cb18-11 aria-hidden=true tabindex=-1></a>    convert <span class=st>&quot;</span><span class=ch>$&lt;</span><span class=st>&quot;</span> -quality 50 -resize 800x800\&gt; <span class=st>&quot;</span><span class=ch>$@</span><span class=st>&quot;</span></span>
<span id=cb18-12><a href=#cb18-12 aria-hidden=true tabindex=-1></a></span>
<span id=cb18-13><a href=#cb18-13 aria-hidden=true tabindex=-1></a><span class=dv>$(DST_DIR)/%.gif:</span><span class=dt> </span><span class=ch>$(</span><span class=dt>SRC_DIR</span><span class=ch>)</span><span class=dt>/%.gif</span></span>
<span id=cb18-14><a href=#cb18-14 aria-hidden=true tabindex=-1></a>    <span class=ch>@</span><span class=fu>mkdir -p </span><span class=ch>$(</span><span class=kw>dir</span><span class=st> </span><span class=ch>$@)</span></span>
<span id=cb18-15><a href=#cb18-15 aria-hidden=true tabindex=-1></a>    convert <span class=st>&quot;</span><span class=ch>$&lt;</span><span class=st>&quot;</span> -quality 50 -resize 800x800\&gt; <span class=st>&quot;</span><span class=ch>$@</span><span class=st>&quot;</span></span>
<span id=cb18-16><a href=#cb18-16 aria-hidden=true tabindex=-1></a></span>
<span id=cb18-17><a href=#cb18-17 aria-hidden=true tabindex=-1></a><span class=dv>$(DST_DIR)/%.png:</span><span class=dt> </span><span class=ch>$(</span><span class=dt>SRC_DIR</span><span class=ch>)</span><span class=dt>/%.png</span></span>
<span id=cb18-18><a href=#cb18-18 aria-hidden=true tabindex=-1></a>    <span class=ch>@</span><span class=fu>mkdir -p </span><span class=ch>$(</span><span class=kw>dir</span><span class=st> </span><span class=ch>$@)</span></span>
<span id=cb18-19><a href=#cb18-19 aria-hidden=true tabindex=-1></a>    convert <span class=st>&quot;</span><span class=ch>$&lt;</span><span class=st>&quot;</span> -quality 50 -resize 800x800\&gt; <span class=st>&quot;</span><span class=ch>$@</span><span class=st>&quot;</span></span>
<span id=cb18-20><a href=#cb18-20 aria-hidden=true tabindex=-1></a></span>
<span id=cb18-21><a href=#cb18-21 aria-hidden=true tabindex=-1></a><span class=ot>.PHONY:</span><span class=dt> img</span></span>
<span id=cb18-22><a href=#cb18-22 aria-hidden=true tabindex=-1></a><span class=dv>img:</span><span class=dt> </span><span class=ch>$(</span><span class=dt>DST_IMG_FILES</span><span class=ch>)</span></span>
<span id=cb18-23><a href=#cb18-23 aria-hidden=true tabindex=-1></a><span class=dt>ALL </span><span class=ch>+=</span><span class=st> </span><span class=ch>$(</span><span class=dt>DST_IMG_FILES</span><span class=ch>)</span></span></code></pre></div><h2 id=deploy>Deploy</h2><p>A nice bonus is that I also deploy my website using make.<div class=sourceCode id=cb19><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id=cb19-1><a href=#cb19-1 aria-hidden=true tabindex=-1></a><span class=co># DEPLOY</span></span>
<span id=cb19-2><a href=#cb19-2 aria-hidden=true tabindex=-1></a><span class=ot>.PHONY:</span><span class=dt> site</span></span>
<span id=cb19-3><a href=#cb19-3 aria-hidden=true tabindex=-1></a><span class=dv>site:</span><span class=dt> </span><span class=ch>$(</span><span class=dt>ALL</span><span class=ch>)</span></span>
<span id=cb19-4><a href=#cb19-4 aria-hidden=true tabindex=-1></a></span>
<span id=cb19-5><a href=#cb19-5 aria-hidden=true tabindex=-1></a><span class=ot>.PHONY:</span><span class=dt> deploy</span></span>
<span id=cb19-6><a href=#cb19-6 aria-hidden=true tabindex=-1></a><span class=dv>deploy:</span><span class=dt> </span><span class=ch>$(</span><span class=dt>ALL</span><span class=ch>)</span></span>
<span id=cb19-7><a href=#cb19-7 aria-hidden=true tabindex=-1></a>    engine/sync.sh</span>
<span id=cb19-8><a href=#cb19-8 aria-hidden=true tabindex=-1></a></span>
<span id=cb19-9><a href=#cb19-9 aria-hidden=true tabindex=-1></a><span class=ot>.PHONY:</span><span class=dt> clean</span></span>
<span id=cb19-10><a href=#cb19-10 aria-hidden=true tabindex=-1></a><span class=dv>clean:</span></span>
<span id=cb19-11><a href=#cb19-11 aria-hidden=true tabindex=-1></a>    <span class=ch>-</span><span class=fu>[ ! -z </span><span class=st>&quot;</span><span class=ch>$(</span><span class=dt>DST_DIR</span><span class=ch>)</span><span class=st>&quot;</span><span class=fu> ] &amp;&amp; rm -rf </span><span class=ch>$(</span><span class=dt>DST_DIR</span><span class=ch>)</span><span class=fu>/*</span></span>
<span id=cb19-12><a href=#cb19-12 aria-hidden=true tabindex=-1></a>    <span class=ch>-</span><span class=fu>[ ! -z </span><span class=st>&quot;</span><span class=ch>$(</span><span class=dt>CACHE_DIR</span><span class=ch>)</span><span class=st>&quot;</span><span class=fu> ] &amp;&amp; rm -rf </span><span class=ch>$(</span><span class=dt>CACHE_DIR</span><span class=ch>)</span><span class=fu>/*</span></span></code></pre></div></article></main><footer id=postamble class=status><div class=content><nav role=navigation><a href=/index.html>Home</a> |
<a href=/slides.html>Slides</a> |
<a href=/about-me.html>About</a>
<span class=details>(<a href=https://git.esy.fun/yogsototh>code</a>
<a href=https://espial.esy.fun/u:yogsototh>bookmarks</a>
<a href=https://espial.esy.fun/u:yogsototh/notes>notes</a>)</span> |
<a href=#logo>↑ Top ↑</a></nav></div></footer>